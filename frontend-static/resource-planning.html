<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resource Planning - Portfolio Management System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            color: #1e293b;
            line-height: 1.6;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
            background: #f8fafc;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            padding: 32px 40px;
            margin: 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-bottom: 1px solid #334155;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.025em;
        }

        .header .subtitle {
            color: #cbd5e1;
            font-size: 16px;
            font-weight: 400;
            opacity: 0.9;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 4px;
            margin: 40px;
            margin-bottom: 0;
            background: white;
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .nav-tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            border-radius: 8px;
            text-decoration: none;
            color: #64748b;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
            position: relative;
        }

        .nav-tab:hover {
            background: #f1f5f9;
            color: #334155;
        }

        .nav-tab.active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        /* Controls Section */
        .controls-section {
            padding: 20px;
            background: white;
        }

        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .controls-header h3 {
            color: #0f172a;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: -0.025em;
        }

        .view-switcher {
            display: flex;
            gap: 4px;
            background: #f1f5f9;
            padding: 6px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .view-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            transition: all 0.2s ease;
        }

        .view-btn.active {
            background: white;
            color: #1e293b;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .view-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.7);
            color: #334155;
        }

        /* View Mode Switcher */
        .view-mode-switcher {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .view-mode-btn {
            padding: 12px 24px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            color: #64748b;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .view-mode-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .view-mode-btn:hover:not(.active) {
            background: #f8fafc;
            color: #334155;
            border-color: #3b82f6;
            transform: translateY(-1px);
        }

        /* Booking Form */
        .booking-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 16px;
        }

        .booking-form.compact {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 12px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
            letter-spacing: -0.025em;
        }

        .form-group select,
        .form-group input {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
            font-weight: 500;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Radio Button Groups */
        .radio-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #374151;
        }

        .radio-option input[type="radio"] {
            width: 16px;
            height: 16px;
            border: 2px solid #d1d5db;
            border-radius: 50%;
            appearance: none;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }

        .radio-option input[type="radio"]:checked {
            border-color: #3b82f6;
            background: #3b82f6;
        }

        .radio-option input[type="radio"]:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: white;
        }

        .radio-option:hover input[type="radio"] {
            border-color: #3b82f6;
        }

        /* Enhanced date range section */
        .date-range-section {
            border: 2px solid #007bff !important;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%) !important;
            box-shadow: 0 4px 8px rgba(0,123,255,0.1);
        }

        .date-range-section input[type="date"] {
            border: 2px solid #007bff !important;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .date-range-section input[type="date"]:hover {
            border-color: #0056b3 !important;
            box-shadow: 0 2px 8px rgba(0,123,255,0.2);
        }

        .date-range-section input[type="date"]:focus {
            border-color: #0056b3 !important;
            box-shadow: 0 0 0 4px rgba(0,123,255,0.15);
        }

        /* Quick preset buttons */
        .preset-btn {
            transition: all 0.2s ease;
        }

        .preset-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }

        /* Booking Type Toggle */
        .booking-type-toggle {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .booking-type-btn {
            padding: 8px 16px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .booking-type-btn.hard {
            border-color: #28a745;
            color: #28a745;
        }

        .booking-type-btn.hard.active {
            background: #28a745;
            color: white;
        }

        .booking-type-btn.soft {
            border-color: #ffc107;
            color: #ffc107;
        }

        .booking-type-btn.soft.active {
            background: #ffc107;
            color: #212529;
        }

        /* Allocation Method Toggle */
        .allocation-methods {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .allocation-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .allocation-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        /* Action Buttons */
        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn.primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn.primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }

        .btn.secondary {
            background: white;
            color: #64748b;
            border: 2px solid #e5e7eb;
        }

        .btn.secondary:hover {
            background: #f8fafc;
            border-color: #d1d5db;
            color: #374151;
            transform: translateY(-1px);
        }

        .btn.success {
            background: #28a745;
            color: white;
        }

        /* Gantt Chart Container */
        .gantt-container {
            background: white;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .gantt-header {
            background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .gantt-header h4 {
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .date-navigator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-arrow {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .nav-arrow:hover {
            background: rgba(255,255,255,0.3);
        }

        .current-period {
            font-weight: 500;
            font-size: 14px;
        }

        /* Gantt Chart Main Area */
        .gantt-main {
            display: flex;
            height: 600px;
            overflow: hidden;
            margin: 20px 40px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            background: white;
            position: relative;
        }

        .gantt-sidebar {
            width: 240px;
            min-width: 240px;
            max-width: 240px;
            background: white;
            border-right: 1px solid #e5e7eb;
            overflow-y: auto;
            overflow-x: hidden;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .gantt-timeline {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            background: white;
        }

        .gantt-timeline-container {
            flex: 1;
            overflow-x: auto;
            overflow-y: hidden; /* Timeline container should not scroll vertically - let resource-rows-container handle it */
            position: relative;
        }

        .timeline-scroll-container {
            display: flex;
            flex-direction: column;
            min-width: fit-content;
        }

        /* Timeline Header */
        .timeline-header {
            background: #ffffff;
            border-bottom: 2px solid #e9ecef;
            min-height: 80px;
            height: 80px;
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .timeline-weeks {
            display: flex;
            height: 20px;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .timeline-months {
            display: flex;
            height: 30px;
            border-bottom: 1px solid #e9ecef;
        }

        .timeline-days {
            display: flex;
            height: 40px;
        }

        .timeline-week,
        .timeline-month,
        .timeline-day {
            border-right: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            background: #fafafa;
            flex-shrink: 0;
        }

        .timeline-week {
            background: #f8f9fa;
            color: #6c757d;
            font-size: 10px;
            font-weight: 600;
        }

        .timeline-month {
            background: #f1f3f4;
            color: #495057;
        }

        .timeline-day {
            color: #6c757d;
            width: 60px;
            min-width: 60px;
            max-width: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2px;
            box-sizing: border-box;
        }

        .timeline-day.weekend {
            background: #fff3cd;
            color: #856404;
        }

        .timeline-day.today {
            background: #d4edda;
            color: #155724;
            font-weight: 600;
        }

        /* Resource Rows */
        .resource-list {
            flex: 1;
        }
        
        .resource-rows-container {
            overflow-y: auto;
            overflow-x: visible;
            flex: 1;
            background: white;
            position: relative;
            z-index: 1;
            padding-top: 6px;
            max-height: calc(100% - 60px); /* Allow room for timeline header */
        }

        .project-group {
            border-bottom: 2px solid #e9ecef;
            position: relative;
            overflow: hidden;
        }

        .project-header {
            display: flex;
            min-height: 42px;
            height: 42px;
            align-items: center;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            position: relative;
            z-index: 15;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .project-header:hover {
            background: #e9ecef;
        }

        .project-header-info {
            width: 240px;
            min-width: 240px;
            max-width: 240px;
            padding: 8px 16px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 8px;
            overflow: hidden;
        }

        .project-expand-icon {
            width: 16px;
            height: 16px;
            transition: transform 0.2s ease;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .project-header.expanded .project-expand-icon {
            transform: rotate(90deg);
        }

        .project-details {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .project-name {
            font-weight: 600;
            font-size: 14px;
            color: #212529;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-meta {
            font-size: 12px;
            color: #6c757d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .project-status.active {
            background: #d4edda;
            color: #155724;
        }

        .project-status.planning {
            background: #fff3cd;
            color: #856404;
        }

        .project-resources {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            position: relative;
            z-index: 1;
            background: white;
        }

        .project-resources.expanded {
            max-height: 800px;
            overflow: visible;
            padding-top: 6px;
        }

        /* Timeline project grouping */
        .gantt-timeline .project-group {
            border-bottom: 2px solid #e9ecef;
        }

        .gantt-timeline .project-header {
            background: #f8f9fa;
        }

        .gantt-timeline .project-resources {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .gantt-timeline .project-resources.expanded {
            max-height: 1000px;
        }

        /* Allocation Numbers */
        .allocation-number {
            background: linear-gradient(135deg, #007bff, #0056b3);
            border-radius: 12px;
            border: none;
            box-shadow: 0 2px 6px rgba(0,123,255,0.3);
            font-size: 10px !important;
            font-weight: 700 !important;
            color: white !important;
            padding: 4px 8px;
            white-space: nowrap;
            min-width: 24px;
            text-align: center;
        }

        .allocation-number.over-allocated {
            background: linear-gradient(135deg, #dc3545, #c82333) !important;
            box-shadow: 0 2px 6px rgba(220,53,69,0.4) !important;
            animation: pulse 2s infinite;
        }

        .allocation-number.over-allocated::after {
            content: '‚ö†Ô∏è';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 12px;
            background: #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        /* Enhanced booking bars */
        .booking-bar {
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid rgba(255,255,255,0.3);
        }

        .booking-bar.hard {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
            border-left-color: #155724;
        }

        .booking-bar.soft {
            background: linear-gradient(135deg, #ffc107, #fd7e14) !important;
            border-left-color: #856404;
        }

        .booking-bar span {
            color: white !important;
            font-weight: 600 !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        /* Capacity indicator */
        .capacity-indicator {
            position: absolute;
            top: 2px;
            font-size: 10px;
            font-weight: 600;
            color: #6c757d;
            background: rgba(255,255,255,0.9);
            padding: 1px 4px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            pointer-events: none;
            z-index: 50;
        }

        .capacity-indicator.over-allocated {
            background: #dc3545;
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .resource-row {
            display: flex;
            min-height: 48px;
            height: 48px;
            border-bottom: 1px solid #e5e7eb;
            align-items: center;
            background: white;
            transition: all 0.2s ease;
            position: relative;
            width: 100%;
            z-index: 15;
        }

        .resource-row:first-child {
            margin-top: 4px;
        }

        /* .resource-row:hover {
            background: #f8fafc;
            border-left: 4px solid #3b82f6;
        } */
        
        .resource-row.monthly-view {
            min-height: 96px;
            height: 96px;
        }
        
        .resource-row.monthly-view .booking-bar {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 2px solid rgba(255,255,255,0.4);
        }

        .resource-sub-row {
            display: flex;
            min-height: 36px;
            height: 36px;
            border-bottom: 1px solid #f1f5f9;
            align-items: center;
            background: #f8fafc;
            transition: all 0.2s ease;
            position: relative;
            z-index: 2;
        }

        /* .resource-sub-row:hover {
            background: #f1f5f9;
        } */

        .resource-sub-row .resource-info {
            padding-left: 40px;
        }

        .expand-btn {
            transition: all 0.2s ease;
            border-radius: 6px;
            padding: 4px;
        }

        .expand-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            transform: scale(1.1);
        }

        .resource-expand-icon {
            width: 16px;
            height: 16px;
            transition: transform 0.2s ease;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            cursor: pointer;
            margin-right: 8px;
            font-size: 14px;
        }

        .resource-expand-icon.expanded {
            transform: rotate(90deg);
        }

        /* Resource expansion spacing fixes (similar to project view) */
        .resource-row {
            position: relative;
            z-index: 10;
        }

        .resource-row.expanded + .resource-sub-rows {
            padding-top: 6px;
            overflow: visible;
        }

        .resource-sub-rows .resource-sub-row:first-child {
            margin-top: 4px;
        }



        .booking-bar.aggregated {
            opacity: 0.9;
            font-weight: 600;
        }

        .resource-info {
            width: 240px;
            min-width: 240px;
            max-width: 240px;
            padding: 12px 16px;
            background: white;
            border-right: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 10px;
            overflow: hidden;
        }

        /* Different padding for project view resources */
        .project-resources .resource-info {
            padding: 8px 16px 8px 32px;
        }

        /* Specific styling for project view resources */
        .project-resource-info {
            min-height: 36px !important;
            height: 36px !important;
        }

        .project-resources .resource-row {
            min-height: 36px !important;
            height: 36px !important;
            position: relative;
        }

        .project-resources .resource-row:first-child {
            margin-top: 4px;
        }

        .project-resources .resource-name {
            font-size: 13px !important;
            font-weight: 600 !important;
            margin-bottom: 2px;
        }

        .project-resources .resource-capacity {
            font-size: 10px !important;
            margin-top: 1px;
            line-height: 1.2;
        }

        .resource-details {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .resource-name {
            font-weight: 600;
            font-size: 14px;
            color: #212529;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .resource-role {
            font-size: 12px;
            color: #64748b;
            font-weight: 500;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .resource-capacity {
            font-size: 11px;
            color: #64748b;
            margin-top: 3px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
        }

        /* Main Content Area */
        .main-content {
            margin: 20px;
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            min-height: calc(100vh - 200px);
        }
        
        /* Left Panel - Controls */
        .left-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            overflow: hidden;
            height: fit-content;
        }
        
        /* Right Panel - Visualization */
        .right-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* Responsive Layout */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 320px 1fr;
            }
        }
        
        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .left-panel {
                order: 2;
            }
            
            .right-panel {
                order: 1;
            }
        }

        .content-header {
            padding: 24px 32px;
            border-bottom: 1px solid #e5e7eb;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .content-header h2 {
            font-size: 24px;
            font-weight: 700;
            color: #0f172a;
            margin: 0;
            letter-spacing: -0.025em;
        }

        .sidebar-header {
            height: 80px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-bottom: 2px solid #475569;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }

        .sidebar-header h3 {
            font-weight: 700;
            color: white;
            font-size: 18px;
            margin: 0;
            letter-spacing: -0.025em;
        }

        /* Booking Bars */
        .resource-timeline {
            position: relative;
            height: 48px;
            background: white;
            display: flex;
            align-items: center;
            overflow: visible;
        }

        .timeline-grid-cell {
            box-sizing: border-box;
        }

        .booking-bar {
            position: absolute;
            height: 30px;
            top: 10px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: 11px;
            font-weight: 500;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }



        .booking-bar.hard {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .booking-bar.soft {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            border: 2px dashed rgba(255,255,255,0.3);
        }

        .booking-bar.overbooked {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Warning Messages */
        .warning-message {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #856404;
        }

        .warning-message.error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border-color: #dc3545;
            color: #721c24;
        }

        .warning-icon {
            font-size: 18px;
            font-weight: bold;
        }

        /* Legend */
        .legend {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #495057;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }

        .legend-color.hard {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .legend-color.soft {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            border: 2px dashed rgba(0,0,0,0.3);
        }

        /* Context Menu Styles */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 8px 0;
            min-width: 180px;
            z-index: 9999;
            display: none;
        }

        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #495057;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-menu-item:hover {
            background-color: #f8f9fa;
            color: #007bff;
        }

        .context-menu-item.danger:hover {
            background-color: #fff5f5;
            color: #dc3545;
        }

        .context-menu-separator {
            height: 1px;
            background: #dee2e6;
            margin: 4px 0;
        }

        /* Import Button Styles */
        .import-section {
            padding: 20px;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-bottom: 1px solid #e2e8f0;
        }

        .import-button {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .import-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        .file-input {
            display: none;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .booking-form {
                grid-template-columns: 1fr;
            }

            .gantt-sidebar {
                width: 180px;
            }

            .resource-info {
                width: 180px;
                padding: 8px 10px;
            }

            .timeline-day {
                width: 50px;
                min-width: 50px;
                max-width: 50px;
            }
        }

        @media (max-width: 480px) {
            .gantt-main {
                height: 400px;
            }

            .gantt-sidebar {
                width: 140px;
            }

            .resource-info {
                width: 140px;
                padding: 6px 8px;
            }

            .resource-name {
                font-size: 12px;
            }

            .resource-role {
                font-size: 10px;
            }

            .timeline-day {
                width: 40px;
                min-width: 40px;
                max-width: 40px;
                font-size: 9px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üóìÔ∏è Resource Planning</h1>
            <p class="subtitle">Plan and visualize resource allocations with interactive Gantt charts - v1.3 - Week Numbers & Grid Fixed</p>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <a href="index.html" class="nav-tab">üìä Dashboard</a>
            <a href="index.html" class="nav-tab">üìà Matrix</a>
            <a href="resource-planning.html" class="nav-tab active">üóìÔ∏è Resource Planning</a>
            <a href="table-view.html" class="nav-tab">üìä Table View</a>
            <a href="login.html" class="nav-tab">üë§ Login</a>
        </div>

        <!-- Main Content Grid -->
        <div class="main-content">
            <!-- Left Panel - Controls -->
            <div class="left-panel">
                <!-- Controls Section -->
                <div class="controls-section">
                    <div class="controls-header">
                        <h3>üìã Resource Planning</h3>
                    </div>

                    <!-- Booking Form -->
                    <form class="booking-form compact" id="bookingForm">
                <!-- Row 1: Project and Resource -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Project</label>
                        <select id="projectSelect" required>
                            <option value="">Select Project...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Resource</label>
                        <select id="resourceSelect" required>
                            <option value="">Select Resource...</option>
                        </select>
                    </div>
                </div>

                <!-- Row 2: Booking Type and Dates -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Booking Type</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="bookingType" value="hard" checked onclick="setBookingType('hard')">
                                <span>Hard Booking</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="bookingType" value="soft" onclick="setBookingType('soft')">
                                <span>Soft Booking</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="bookingStartDate" required>
                    </div>

                    <div class="form-group">
                        <label>End Date</label>
                        <input type="date" id="bookingEndDate" required>
                    </div>
                </div>

                <!-- Row 3: Allocation Method and Value -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Allocation Method</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="allocationMethod" value="hours" checked onclick="setAllocationMethod('hours')">
                                <span>Hours/Day</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="allocationMethod" value="percentage" onclick="setAllocationMethod('percentage')">
                                <span>Percentage</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="allocationMethod" value="total" onclick="setAllocationMethod('total')">
                                <span>Total Hours</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Allocation Value</label>
                        <input type="number" id="allocationValue" placeholder="Hours per day" min="0" max="8" step="0.5" required>
                    </div>
                </div>
            </form>

                    <!-- Action Buttons -->
                    <div class="form-actions">
                        <button class="btn primary" onclick="createBooking()">
                            üìÖ Create Booking
                        </button>
                        <button class="btn secondary" onclick="clearForm()">
                            üîÑ Clear Form
                        </button>
                        <button class="btn success" onclick="exportGantt()">
                            üìä Export Gantt
                        </button>
                    </div>

                    <!-- Warning Messages -->
                    <div id="warningContainer"></div>
                </div>

                <!-- Import Section -->
                <div class="import-section">
                    <h4 style="margin-bottom: 12px;">üìÇ Import Resource Allocations</h4>
                    <p style="margin-bottom: 12px; color: #666; font-size: 14px;">Upload a CSV file to bulk import resource allocations. Expected format: Resource Name, Project Name, Start Date, End Date, Allocation Value, Allocation Method, Booking Type</p>
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                        <button type="button" class="import-button" onclick="downloadTemplate()" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                            üì• Download Template
                        </button>
                        <button type="button" class="import-button" onclick="document.getElementById('csvFileInput').click()">
                            üìÅ Choose CSV File
                        </button>
                        <input type="file" id="csvFileInput" class="file-input" accept=".csv" onchange="handleFileImport(event)">
                        <span id="fileStatus" style="color: #666; font-size: 14px;"></span>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Visualization -->
            <div class="right-panel">
                <!-- Legend -->
        <div class="legend" style="display: flex; gap: 20px; margin: 20px 0 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 12px; border: 1px solid #e9ecef;">
            <div style="display: flex; align-items: center; gap: 5px;">
                <div style="width: 16px; height: 16px; background: linear-gradient(135deg, #28a745, #20c997); border-radius: 4px; border-left: 3px solid #155724;"></div>
                <span>üîí Confirmed</span>
            </div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <div style="width: 16px; height: 16px; background: linear-gradient(135deg, #ffc107, #fd7e14); border-radius: 4px; border-left: 3px solid #856404;"></div>
                <span>üìù Tentative</span>
            </div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <div style="width: 20px; height: 16px; background: linear-gradient(135deg, #007bff, #0056b3); border-radius: 8px; color: white; font-size: 10px; font-weight: 700; display: flex; align-items: center; justify-content: center;">8h</div>
                <span>Daily Hours</span>
            </div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <div style="width: 20px; height: 16px; background: linear-gradient(135deg, #dc3545, #c82333); border-radius: 8px; color: white; font-size: 10px; font-weight: 700; display: flex; align-items: center; justify-content: center; position: relative;">9h<span style="position: absolute; top: -8px; right: -8px; font-size: 8px;">‚ö†Ô∏è</span></div>
                <span>Over-allocated</span>
            </div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <div style="padding: 2px 6px; background: rgba(255,255,255,0.9); border: 1px solid #e9ecef; border-radius: 8px; font-size: 10px; font-weight: 600; color: #6c757d;">85%</div>
                <span>Utilization %</span>
            </div>
        </div>

        <!-- Gantt Chart -->
        <div class="gantt-container" id="ganttContainer">
            <div class="gantt-header">
                <h4>üìä Resource Allocation Gantt Chart</h4>
                <div class="date-navigator" style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <!-- Compact Date Range Controls -->
                    <div style="display: flex; align-items: center; gap: 8px; background: white; border: 1px solid #ddd; border-radius: 6px; padding: 4px 8px;">
                        <span style="color: #007bff; font-size: 14px;">üìÖ</span>
                        <input type="date" id="calendarStartDate" style="border: none; outline: none; font-size: 12px; width: 110px;">
                        <span style="color: #999;">‚Äî</span>
                        <input type="date" id="calendarEndDate" style="border: none; outline: none; font-size: 12px; width: 110px;">
                        <button type="button" onclick="updateCalendarView()" style="background: #007bff; color: white; border: none; border-radius: 3px; padding: 2px 6px; font-size: 11px; cursor: pointer;">Update</button>
                    </div>
                    
                    <!-- Preset Buttons -->
                    <div style="display: flex; gap: 4px;">
                        <button type="button" onclick="setCalendarDateRange('thisWeek')" class="preset-btn" style="padding: 3px 8px; background: #28a745; color: white; border: none; border-radius: 3px; font-size: 11px; cursor: pointer;">Week</button>
                        <button type="button" onclick="setCalendarDateRange('thisMonth')" class="preset-btn" style="padding: 3px 8px; background: #17a2b8; color: white; border: none; border-radius: 3px; font-size: 11px; cursor: pointer;">Month</button>
                        <button type="button" onclick="resetToFullYear()" style="padding: 3px 8px; background: #fd7e14; color: white; border: none; border-radius: 3px; font-size: 11px; cursor: pointer; font-weight: 600;">üîÑ Reset</button>
                    </div>
                    
                    <!-- View Mode Switcher -->
                    <div style="display: flex; gap: 4px; align-items: center;">
                        <span style="font-size: 11px; color: #666; font-weight: 600;">View:</span>
                        <button class="view-mode-btn active" onclick="switchViewMode('project')" id="projectViewBtn" style="padding: 3px 8px; background: #6f42c1; color: white; border: none; border-radius: 3px; font-size: 11px; cursor: pointer;">üìÅ Project</button>
                        <button class="view-mode-btn" onclick="switchViewMode('resource')" id="resourceViewBtn" style="padding: 3px 8px; background: #6c757d; color: white; border: none; border-radius: 3px; font-size: 11px; cursor: pointer;">üë• Resource</button>
                    </div>
                    
                    <!-- Time View Switcher -->
                    <div style="display: flex; gap: 4px; align-items: center;">
                        <span style="font-size: 11px; color: #666; font-weight: 600;">Scale:</span>
                        <button class="view-btn active" onclick="switchView('daily')" style="padding: 3px 8px; background: #007bff; color: white; border: none; border-radius: 3px; font-size: 11px; cursor: pointer;">Daily</button>
                        <button class="view-btn" onclick="switchView('weekly')" style="padding: 3px 8px; background: #6c757d; color: white; border: none; border-radius: 3px; font-size: 11px; cursor: pointer;">Weekly</button>
                        <button class="view-btn" onclick="switchView('monthly')" style="padding: 3px 8px; background: #6c757d; color: white; border: none; border-radius: 3px; font-size: 11px; cursor: pointer;">Monthly</button>
                    </div>
                </div>
            </div>
            
            <!-- Calendar Info Display -->
            <div id="calendarDateInfo" style="margin: 10px 0; padding: 8px 12px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #007bff; font-size: 12px; color: #495057;">
                üìä Select date range to view resource allocations
            </div>

            <div class="gantt-main">
                <div class="gantt-sidebar">
                    <!-- Sidebar header -->
                    <div class="sidebar-header">
                        <h3>Resources</h3>
                    </div>
                    <!-- Resource list -->
                    <div class="resource-rows-container" id="resourceList">
                        <!-- Resources will be populated here -->
                    </div>
                </div>

                <div class="gantt-timeline">
                    <div class="gantt-timeline-container" id="ganttTimelineContainer">
                        <div class="timeline-scroll-container">
                            <div class="timeline-header" id="timelineHeader">
                                <!-- Timeline will be populated here -->
                            </div>
                            <div class="resource-rows-container" id="resourceTimelines">
                                <!-- Resource timelines will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div> <!-- End Right Panel -->
        </div> <!-- End Main Content -->
    </div>



    <script>
        // Global variables
        let currentView = 'daily';
        let currentViewMode = 'project'; // 'project' or 'resource'
        let currentDate = new Date();
    // Configuration flags
    const SHOW_RESOURCE_DETAIL_SUBROWS = false; // Disable showing project sub-rows under resources in resource view
    const SHOW_RESOURCE_DETAIL_TIMELINES = false; // Disable extra per-project timelines when resource expanded
        let bookings = [
            {
                id: 1,
                resourceId: 1, // John Smith
                projectId: 1,  // Project Alpha
                startDate: new Date('2025-11-17'),
                endDate: new Date('2025-11-21'),
                hours: 6,
                type: 'hard',
                description: 'Project Alpha Development'
            },
            {
                id: 2,
                resourceId: 2,
                projectId: 1,
                startDate: new Date('2025-11-14'),
                endDate: new Date('2025-11-16'),
                hours: 4,
                type: 'soft',
                description: 'UI Design Review'
            },
            {
                id: 3,
                resourceId: 1, // John Smith
                projectId: 2,  // Project Beta
                startDate: new Date('2025-11-19'),
                endDate: new Date('2025-11-23'),
                hours: 2,
                type: 'hard',
                description: 'Project Beta Development'
            },
            {
                id: 4,
                resourceId: 2, // Sarah Jones
                projectId: 1,  // Project Alpha
                startDate: new Date('2025-11-18'),
                endDate: new Date('2025-11-22'),
                hours: 3,
                type: 'hard',
                description: 'Project Alpha Testing'
            },
            {
                id: 5,
                resourceId: 2, // Sarah Jones
                projectId: 3,  // Project Gamma
                startDate: new Date('2025-11-20'),
                endDate: new Date('2025-11-24'),
                hours: 4,
                type: 'soft',
                description: 'Project Gamma Development'
            },
            {
                id: 6,
                resourceId: 5,
                projectId: 3,
                startDate: new Date('2025-01-16'),
                endDate: new Date('2025-01-18'),
                hours: 4,
                type: 'hard',
                description: 'Infrastructure Setup'
            }
        ];
        // Configuration
        const API_URL = 'http://localhost:3001/api';
        
        // Check authentication first
        let authToken = localStorage.getItem('token');
        if (!authToken) {
            console.log('No authentication token found, redirecting to login...');
            window.location.href = '/login.html';
        }
        
        // Global data variables (loaded from API)
        let resources = [];
        let projects = [];

        let currentBookingType = 'hard';
        let currentAllocationMethod = 'hours';

        // API Helper Functions
        async function makeAuthenticatedRequest(url, options = {}) {
            const token = localStorage.getItem('token');
            return fetch(url, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    ...options.headers
                }
            });
        }

        // Load Resources from API (using keka-employees endpoint)
        async function loadResources() {
            try {
                const response = await makeAuthenticatedRequest(`${API_URL}/keka-employees?status=active`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Raw employee data sample:', data.data.slice(0, 3)); // Debug first 3 employees
                    resources = data.data.map((employee, index) => ({
                        id: employee.employee_id || employee.id || employee.uuid || `temp_${index}`, // Fallback IDs
                        name: employee.first_name && employee.last_name ? 
                              `${employee.first_name} ${employee.last_name}` : 
                              employee.employee_name || `Employee ${employee.employee_id || index}`,
                        role: employee.designation || employee.department || 'Employee',
                        capacity: 8, // Default 8 hours/day
                        avatar: employee.first_name && employee.last_name ? 
                                `${employee.first_name.charAt(0)}${employee.last_name.charAt(0)}` : 
                                employee.employee_name ? employee.employee_name.substring(0, 2).toUpperCase() : 'EM',
                        expanded: false,
                        email: employee.email_address
                    })).filter(resource => resource.id !== undefined); // Remove any with undefined IDs
                    console.log('Loaded resources:', resources);
                } else {
                    console.error('Failed to load resources:', response.status, response.statusText);
                    if (response.status === 401) {
                        console.log('Authentication failed, redirecting to login...');
                        localStorage.removeItem('token');
                        window.location.href = '/login.html';
                        return;
                    }
                    // Fallback to sample data if API fails for other reasons
                    resources = [
                        { id: 1, name: 'John Smith', role: 'Senior Developer', capacity: 8, avatar: 'JS', expanded: false },
                        { id: 2, name: 'Sarah Jones', role: 'UI/UX Designer', capacity: 8, avatar: 'SJ', expanded: false }
                    ];
                }
            } catch (error) {
                console.error('Error loading resources:', error);
                // Fallback to sample data
                resources = [
                    { id: 1, name: 'John Smith', role: 'Senior Developer', capacity: 8, avatar: 'JS', expanded: false },
                    { id: 2, name: 'Sarah Jones', role: 'UI/UX Designer', capacity: 8, avatar: 'SJ', expanded: false }
                ];
            }
        }

        // Load Projects from API (using keka-projects endpoint)
        async function loadProjects() {
            try {
                const response = await makeAuthenticatedRequest(`${API_URL}/keka-projects`);
                if (response.ok) {
                    const data = await response.json();
                    const colors = ['#6f42c1', '#20c997', '#fd7e14', '#e83e8c', '#3b82f6', '#10b981', '#f59e0b', '#ef4444'];
                    
                    // Filter to only include active projects (not archived)
                    const activeProjects = data.data.filter(project => !project.is_archived);
                    
                    projects = activeProjects.map((project, index) => ({
                        id: project.id, // Using correct field name
                        name: project.name || `Project ${project.id}`, // Using correct field name
                        description: project.code || 'No description', // Using project code as description
                        client: project.client_name || 'Unknown Client', // This is correct
                        status: project.status || 'Active',
                        expanded: index === 0, // First project expanded by default
                        color: colors[index % colors.length]
                    }));
                    console.log(`Loaded ${projects.length} active projects (filtered from ${data.data.length} total):`, projects);
                } else {
                    console.error('Failed to load projects:', response.status, response.statusText);
                    if (response.status === 401) {
                        console.log('Authentication failed, redirecting to login...');
                        localStorage.removeItem('token');
                        window.location.href = '/login.html';
                        return;
                    }
                    // Fallback to sample data
                    projects = [
                        { id: 1, name: 'Project Alpha', description: 'Web Development', client: 'Client A', status: 'Active', expanded: true, color: '#6f42c1' },
                        { id: 2, name: 'Project Beta', description: 'Mobile App', client: 'Client B', status: 'Active', expanded: false, color: '#20c997' }
                    ];
                }
            } catch (error) {
                console.error('Error loading projects:', error);
                // Fallback to sample data
                projects = [
                    { id: 1, name: 'Project Alpha', description: 'Web Development', client: 'Client A', status: 'Active', expanded: true, color: '#6f42c1' },
                    { id: 2, name: 'Project Beta', description: 'Mobile App', client: 'Client B', status: 'Active', expanded: false, color: '#20c997' }
                ];
            }
        }

        // Load Bookings from API
        async function loadBookings() {
            try {
                const response = await makeAuthenticatedRequest(`${API_URL}/resource-planning/bookings`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Raw booking data from API:', data.data);
                    bookings = data.data.map((booking, index) => {
                        // API returns snake_case, so use those field names
                        const resourceId = booking.resource_id || booking.resourceId;
                        const projectId = booking.project_id || booking.projectId;
                        
                        // Map numeric IDs back to UUIDs by finding matching resources/projects
                        const resource = resources.find(r => {
                            const rIndex = resources.indexOf(r) + 1;
                            return rIndex === resourceId;
                        });
                        const project = projects.find(p => {
                            const pIndex = projects.indexOf(p) + 1;
                            return pIndex === projectId;
                        });
                        
                        const resourceUUID = resource?.id || resourceId;
                        const projectUUID = project?.id || projectId;
                        
                        const bookingObj = {
                            id: Date.now() + Math.random() + index, // Local unique ID
                            apiId: booking.id, // API ID for updates/deletes
                            resourceId: resourceUUID,
                            projectId: projectUUID,
                            startDate: new Date(booking.start_date || booking.startDate),
                            endDate: new Date(booking.end_date || booking.endDate),
                            hours: parseFloat(booking.daily_hours || booking.dailyHours),
                            dailyHours: parseFloat(booking.daily_hours || booking.dailyHours),
                            allocationValue: parseFloat(booking.allocation_value || booking.allocationValue),
                            allocationMethod: booking.allocation_method || booking.allocationMethod,
                            type: booking.booking_type || booking.type,
                            description: booking.description || `${booking.booking_type || booking.type} booking - ${booking.allocation_value || booking.allocationValue} ${(booking.allocation_method || booking.allocationMethod) === 'hours' ? 'hours/day' : (booking.allocation_method || booking.allocationMethod) === 'percentage' ? '%' : 'total hours'}`
                        };
                        
                        console.log(`Mapped booking ${index + 1}:`, bookingObj);
                        return bookingObj;
                    });
                    console.log('Loaded bookings:', bookings);
                    updateGanttChart();
                } else {
                    console.log('No existing bookings found, starting with empty set');
                    bookings = [];
                }
            } catch (error) {
                console.error('Error loading bookings:', error);
                bookings = [];
            }
        }

        // Initialize data loading
        async function initializeData() {
            // Check authentication first
            if (!authToken) {
                window.location.href = 'login.html';
                return;
            }

            try {
                // Load resources and projects first
                await Promise.all([
                    loadResources(),
                    loadProjects()
                ]);
                
                // Then load bookings (which need resource/project data for mapping)
                await loadBookings();
                
                // Update UI after data is loaded
                updateResourceDropdown();
                updateProjectDropdown();
                updateGanttChart();
                
                console.log('Data initialization complete');
            } catch (error) {
                console.error('Failed to initialize data:', error);
            }
        }

        // Populate resource select dropdown
        function populateResourceSelect() {
            const select = document.getElementById('resourceSelect');
            select.innerHTML = '<option value="">Select Resource...</option>';
            resources.forEach(resource => {
                const option = document.createElement('option');
                option.value = resource.id;
                option.textContent = resource.name; // Show only employee name
                select.appendChild(option);
            });
        }
        
        // Populate project select dropdown  
        function populateProjectSelect() {
            const select = document.getElementById('projectSelect');
            select.innerHTML = '<option value="">Select Project...</option>';
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name; // Show only project name
                select.appendChild(option);
            });
        }

        // Update dropdown functions (aliases for API initialization)
        function updateResourceDropdown() {
            populateResourceSelect();
        }

        function updateProjectDropdown() {
            populateProjectSelect();
        }

        // Set calendar date range presets
        function setCalendarDateRange(preset) {
            const today = new Date();
            let startDate, endDate;
            
            switch(preset) {
                case 'thisWeek':
                    // Start from Monday of current week
                    const dayOfWeek = today.getDay();
                    const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() + mondayOffset);
                    
                    // End on Friday of current week
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 4);
                    break;
                    
                case 'thisMonth':
                    // Start from first day of current month
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    
                    // End on last day of current month
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                    
                case 'nextMonth':
                    // Start from first day of next month
                    startDate = new Date(today.getFullYear(), today.getMonth() + 1, 1);
                    
                    // End on last day of next month
                    endDate = new Date(today.getFullYear(), today.getMonth() + 2, 0);
                    break;
                    
                default:
                    return;
            }
            
            // Set the calendar date inputs
            document.getElementById('calendarStartDate').valueAsDate = startDate;
            document.getElementById('calendarEndDate').valueAsDate = endDate;
            
            // Update the view automatically
            updateCalendarView();
            
            // Show feedback to user
            showCalendarDateRangeInfo(preset, startDate, endDate);
        }
        
        // Set default full year range (current date + 12 months)
        function setDefaultFullYearRange() {
            const today = new Date();
            const startDate = new Date(today);
            const endDate = new Date(today);
            endDate.setFullYear(today.getFullYear() + 1);
            
            // Set the calendar date inputs
            document.getElementById('calendarStartDate').valueAsDate = startDate;
            document.getElementById('calendarEndDate').valueAsDate = endDate;
            
            // Update the view automatically
            updateCalendarView();
            
            // Show feedback to user
            const workingDays = getWorkingDaysBetween(startDate, endDate);
            updateCalendarInfo(`üìä Full Year View | ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()} | ${workingDays} working days`);
        }
        
        // Reset to default full year range
        function resetToFullYear() {
            setDefaultFullYearRange();
        }
        
        // Update calendar view
        function updateCalendarView() {
            if (validateCalendarDateRange()) {
                updateGanttChart();
                updateCurrentPeriodDisplay();
            }
        }
        
        // Show calendar date range information
        function showCalendarDateRangeInfo(preset, startDate, endDate) {
            const info = {
                'thisWeek': 'Current Week (Mon-Fri)',
                'thisMonth': 'Current Month (Working Days)',
                'nextMonth': 'Next Month (Working Days)'
            };
            
            const workingDays = getWorkingDaysBetween(startDate, endDate);
            const message = `üìÖ ${info[preset]} | ${workingDays} working days | ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
            
            // Update the info display
            const infoElement = document.getElementById('calendarDateInfo');
            infoElement.innerHTML = `üìä ${message}`;
            
            // Show temporary notification
            showNotification(message, 'success');
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            // Remove existing notification
            const existing = document.querySelector('.date-notification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.className = `date-notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1'};
                color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460'};
                border: 1px solid ${type === 'success' ? '#c3e6cb' : type === 'error' ? '#f5c6cb' : '#bee5eb'};
                border-radius: 8px;
                padding: 12px 16px;
                font-size: 14px;
                font-weight: 600;
                z-index: 1000;
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 3000);
        }
        
        // Validate calendar date range
        function validateCalendarDateRange() {
            const startDate = new Date(document.getElementById('calendarStartDate').value);
            const endDate = new Date(document.getElementById('calendarEndDate').value);
            
            if (!document.getElementById('calendarStartDate').value || !document.getElementById('calendarEndDate').value) {
                showNotification('Please select both calendar start and end dates', 'error');
                updateCalendarInfo('‚ùå Please select both start and end dates');
                return false;
            }
            
            if (startDate >= endDate) {
                showNotification('End date must be after start date', 'error');
                updateCalendarInfo('‚ùå End date must be after start date');
                return false;
            }
            
            const daysDiff = (endDate - startDate) / (1000 * 60 * 60 * 24);
            if (daysDiff > 365) {
                showNotification('Date range cannot exceed 1 year', 'error');
                updateCalendarInfo('‚ùå Date range cannot exceed 1 year');
                return false;
            }
            
            return true;
        }
        
        // Update calendar info display
        function updateCalendarInfo(message) {
            const infoElement = document.getElementById('calendarDateInfo');
            infoElement.innerHTML = message;
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', async function() {
            // Set default booking form dates
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            document.getElementById('bookingStartDate').valueAsDate = today;
            document.getElementById('bookingEndDate').valueAsDate = nextWeek;
            
            // Set default calendar dates to full year (current date + 12 months)
            setDefaultFullYearRange();
            
            // Add calendar date change listeners
            document.getElementById('calendarStartDate').addEventListener('change', updateCalendarView);
            document.getElementById('calendarEndDate').addEventListener('change', updateCalendarView);
            
            // Initialize Gantt chart
            initializeGanttChart();
            
            // Initialize data from API (replaces sample data)
            await initializeData();
            
            // Setup synchronized scrolling
            setupSynchronizedScrolling();
            
            // Setup responsive resize handling
            setupResponsiveResize();
        });
        
        // Setup responsive resize handling
        function setupResponsiveResize() {
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    // Recalculate and update grid when window resizes
                    updateGanttChart();
                }, 300); // Debounce resize events
            });
        }
        
        // Setup synchronized scrolling between resource list and timeline
        function setupSynchronizedScrolling() {
            const resourceList = document.getElementById('resourceList');
            const resourceTimelines = document.getElementById('resourceTimelines');
            
            if (resourceList && resourceTimelines) {
                let isScrolling = false;
                
                resourceList.addEventListener('scroll', function() {
                    if (!isScrolling) {
                        isScrolling = true;
                        resourceTimelines.scrollTop = this.scrollTop;
                        requestAnimationFrame(() => {
                            isScrolling = false;
                        });
                    }
                });
                
                resourceTimelines.addEventListener('scroll', function() {
                    if (!isScrolling) {
                        isScrolling = true;
                        resourceList.scrollTop = this.scrollTop;
                        requestAnimationFrame(() => {
                            isScrolling = false;
                        });
                    }
                });
                
                console.log('Synchronized scrolling setup complete for resourceList and resourceTimelines');
            } else {
                console.warn('Could not setup synchronized scrolling - elements not found:', {
                    resourceList: !!resourceList,
                    resourceTimelines: !!resourceTimelines
                });
            }
        }

        // View switching
        function switchView(view) {
            currentView = view;
            // Update button styles for time view switcher
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.style.background = '#6c757d';
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            event.target.style.background = '#007bff';
            updateGanttChart();
        }

        // View mode switching (Project vs Resource)
        function switchViewMode(mode) {
            currentViewMode = mode;
            // Update button styles for view mode switcher
            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = '#6c757d';
            });
            event.target.classList.add('active');
            event.target.style.background = '#6f42c1';
            updateGanttChart();
        }



        // Booking type selection
        function setBookingType(type) {
            currentBookingType = type;
            // Update radio button selection (the radio buttons handle their own visual state)
            const radioButton = document.querySelector(`input[name="bookingType"][value="${type}"]`);
            if (radioButton) {
                radioButton.checked = true;
            }
            console.log('Booking type set to:', type);
        }

        // Allocation method selection
        function setAllocationMethod(method) {
            currentAllocationMethod = method;
            document.querySelectorAll('.allocation-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const input = document.getElementById('allocationValue');
            switch(method) {
                case 'hours':
                    input.placeholder = 'Hours per day';
                    input.max = '8';
                    input.step = '0.5';
                    break;
                case 'percentage':
                    input.placeholder = 'Percentage (0-100)';
                    input.max = '100';
                    input.step = '5';
                    break;
                case 'total':
                    input.placeholder = 'Total hours';
                    input.max = '1000';
                    input.step = '1';
                    break;
            }
        }

        // Create booking
        async function createBooking() {
            const form = document.getElementById('bookingForm');
            const formData = new FormData(form);
            
            // Get dropdown elements and their selected options for detailed debugging
            const resourceSelect = document.getElementById('resourceSelect');
            const projectSelect = document.getElementById('projectSelect');
            const resourceSelectValue = resourceSelect.value;
            const projectSelectValue = projectSelect.value;
            const resourceSelectedOption = resourceSelect.options[resourceSelect.selectedIndex];
            const projectSelectedOption = projectSelect.options[projectSelect.selectedIndex];
            
            // Get other form values
            const startDateValue = document.getElementById('bookingStartDate').value;
            const endDateValue = document.getElementById('bookingEndDate').value;
            const allocationValueValue = document.getElementById('allocationValue').value;
            
            // Handle IDs - they might be UUIDs (strings) or numeric values
            const resourceId = resourceSelectValue && resourceSelectValue !== 'undefined' && resourceSelectValue !== '' ? resourceSelectValue : null;
            const projectId = projectSelectValue && projectSelectValue !== 'undefined' && projectSelectValue !== '' ? projectSelectValue : null;
            const startDate = startDateValue ? new Date(startDateValue) : new Date('invalid');
            const endDate = endDateValue ? new Date(endDateValue) : new Date('invalid');
            const allocationValue = allocationValueValue ? parseFloat(allocationValueValue) : NaN;
            
            // Enhanced debug logging to see dropdown states
            console.log('Enhanced Form validation:', {
                dropdowns: {
                    resourceSelect: {
                        value: resourceSelectValue,
                        selectedIndex: resourceSelect.selectedIndex,
                        selectedOption: resourceSelectedOption ? {
                            value: resourceSelectedOption.value,
                            text: resourceSelectedOption.text
                        } : null,
                        optionsCount: resourceSelect.options.length
                    },
                    projectSelect: {
                        value: projectSelectValue,
                        selectedIndex: projectSelect.selectedIndex,
                        selectedOption: projectSelectedOption ? {
                            value: projectSelectedOption.value,
                            text: projectSelectedOption.text
                        } : null,
                        optionsCount: projectSelect.options.length
                    }
                },
                raw: {
                    resourceSelectValue,
                    projectSelectValue,
                    startDateValue,
                    endDateValue,
                    allocationValueValue
                },
                parsed: {
                    resourceId,
                    projectId,
                    startDate,
                    endDate,
                    allocationValue
                },
                validation: {
                    resourceIdValid: !isNaN(resourceId) && resourceId > 0,
                    projectIdValid: !isNaN(projectId) && projectId > 0,
                    resourceIdRaw: resourceId,
                    projectIdRaw: projectId
                }
            });
            
            // Check for empty fields first
            if (!resourceSelectValue || !projectSelectValue || !startDateValue || !endDateValue || allocationValueValue === '' || allocationValueValue === null) {
                const missingFields = [];
                if (!resourceSelectValue) missingFields.push('Resource');
                if (!projectSelectValue) missingFields.push('Project');
                if (!startDateValue) missingFields.push('Start Date');
                if (!endDateValue) missingFields.push('End Date');
                if (allocationValueValue === '' || allocationValueValue === null) missingFields.push('Allocation Value');
                
                console.error('Validation failed - empty fields:', {
                    resourceSelect: !resourceSelectValue,
                    projectSelect: !projectSelectValue,
                    startDate: !startDateValue,
                    endDate: !endDateValue,
                    allocationValue: allocationValueValue === '' || allocationValueValue === null,
                    missingFields
                });
                showWarning(`Please fill in the following required fields: ${missingFields.join(', ')}`, 'error');
                return;
            }
            
            // More detailed debugging for the ID validation issue
            console.log('Detailed validation check:', {
                resourceSelectValue,
                projectSelectValue,
                resourceId,
                projectId,
                checks: {
                    'resourceId is null': resourceId === null,
                    'projectId is null': projectId === null,
                    'typeof resourceId': typeof resourceId,
                    'typeof projectId': typeof projectId,
                    'resourceId length': resourceId ? resourceId.length : 'N/A',
                    'projectId length': projectId ? projectId.length : 'N/A'
                }
            });

            // Updated validation for UUID/string IDs instead of numeric IDs
            if (!resourceId || !projectId || isNaN(allocationValue) || allocationValue <= 0) {
                const invalidFields = [];
                if (!resourceId) invalidFields.push('Resource (please select a valid resource)');
                if (!projectId) invalidFields.push('Project (please select a valid project)');
                if (isNaN(allocationValue) || allocationValue <= 0) invalidFields.push('Allocation Value (must be greater than 0)');
                
                console.error('Validation failed - ID/value validation:', {
                    resourceId: !resourceId,
                    projectId: !projectId,
                    allocationValue: isNaN(allocationValue) || allocationValue <= 0,
                    invalidFields
                });
                showWarning(`Please fix the following fields: ${invalidFields.join(', ')}`, 'error');
                return;
            }
            
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                console.error('Validation failed - invalid dates:', {
                    startDate: isNaN(startDate.getTime()),
                    endDate: isNaN(endDate.getTime())
                });
                showWarning('Please enter valid dates.', 'error');
                return;
            }
            
            if (startDate >= endDate) {
                showWarning('End date must be after start date.', 'error');
                return;
            }
            
            // Calculate daily hours based on allocation method
            let dailyHours;
            const workingDays = getWorkingDaysBetween(startDate, endDate);
            
            switch(currentAllocationMethod) {
                case 'hours':
                    dailyHours = allocationValue;
                    break;
                case 'percentage':
                    dailyHours = (allocationValue / 100) * 8;
                    break;
                case 'total':
                    dailyHours = allocationValue / workingDays;
                    break;
            }
            
            // Check for overbooking
            const overbookingCheck = checkOverbooking(resourceId, startDate, endDate, dailyHours);
            if (overbookingCheck.isOverbooked) {
                showWarning(`Warning: This booking would cause overbooking on ${overbookingCheck.conflictDates.join(', ')}. Resource capacity is 8 hours per day.`, 'error');
                return;
            }
            
            // Find numeric IDs for the resource planning API
            // The resource-planning API expects numeric IDs, but we have UUIDs from Keka
            const selectedResource = resources.find(r => r.id === resourceId);
            const selectedProject = projects.find(p => p.id === projectId);
            
            // For now, we'll use a simple mapping - in production, this should be handled by the backend
            const numericResourceId = selectedResource ? resources.indexOf(selectedResource) + 1 : 1;
            const numericProjectId = selectedProject ? projects.indexOf(selectedProject) + 1 : 1;

            console.log('ID Mapping:', {
                original: { resourceId, projectId },
                selectedResource: selectedResource ? { id: selectedResource.id, name: selectedResource.name } : null,
                selectedProject: selectedProject ? { id: selectedProject.id, name: selectedProject.name } : null,
                mapped: { numericResourceId, numericProjectId }
            });

            // Create the booking object for API
            const bookingData = {
                resourceId: numericResourceId,
                projectId: numericProjectId,
                startDate: startDate.toISOString().split('T')[0], // API expects YYYY-MM-DD format
                endDate: endDate.toISOString().split('T')[0],
                allocationMethod: currentAllocationMethod,
                allocationValue: allocationValue,
                type: currentBookingType
            };
            
            try {
                // Save to API
                const url = `${API_URL}/resource-planning/bookings`;
                console.log('Creating booking with URL:', url);
                console.log('Booking data:', bookingData);
                
                const response = await makeAuthenticatedRequest(url, {
                    method: 'POST',
                    body: JSON.stringify(bookingData)
                });
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Booking created successfully:', result);
                    
                    // Add to local bookings array with API response data
                    const booking = {
                        id: Date.now() + Math.random(), // Local unique ID
                        apiId: result.data.id, // API ID for updates/deletes
                        resourceId: resourceId,
                        projectId: projectId,
                        startDate: startDate,
                        endDate: endDate,
                        dailyHours: dailyHours,
                        type: currentBookingType,
                        allocationMethod: currentAllocationMethod,
                        allocationValue: allocationValue,
                        description: `${currentBookingType} booking - ${allocationValue} ${currentAllocationMethod === 'hours' ? 'hours/day' : currentAllocationMethod === 'percentage' ? '%' : 'total hours'}`
                    };
                    
                    bookings.push(booking);
                    updateGanttChart();
                    clearForm();
                    
                    const resourceName = resources.find(r => r.id === resourceId)?.name || 'Resource';
                    showWarning(`Booking created successfully for ${resourceName}!`, 'success');
                } else {
                    console.error('Failed to create booking. Status:', response.status);
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    let errorMessage = 'Unknown error';
                    try {
                        const error = JSON.parse(errorText);
                        errorMessage = error.message || error.error || 'Unknown error';
                    } catch (e) {
                        errorMessage = errorText || 'Server error';
                    }
                    showWarning(`Failed to create booking: ${errorMessage}`, 'error');
                }
            } catch (error) {
                console.error('Error creating booking:', error);
                showWarning('Failed to create booking. Please try again.', 'error');
            }
        }

        // Clear form
        function clearForm() {
            document.getElementById('bookingForm').reset();
            
            // Reset to defaults
            currentBookingType = 'hard';
            currentAllocationMethod = 'hours';
            
            // Set the hard booking radio button as default
            const hardRadio = document.querySelector('input[name="bookingType"][value="hard"]');
            if (hardRadio) {
                hardRadio.checked = true;
            }
            
            // Reset allocation method buttons
            document.querySelectorAll('.allocation-btn').forEach(btn => btn.classList.remove('active'));
            const firstAllocationBtn = document.querySelector('.allocation-btn');
            if (firstAllocationBtn) {
                firstAllocationBtn.classList.add('active');
            }
        }

        // Check for overbooking
        function checkOverbooking(resourceId, startDate, endDate, dailyHours) {
            const conflictDates = [];
            const currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                if (isWorkingDay(currentDate)) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const existingHours = getTotalHoursForResourceOnDate(resourceId, currentDate);
                    
                    if (existingHours + dailyHours > 8) {
                        conflictDates.push(dateStr);
                    }
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return {
                isOverbooked: conflictDates.length > 0,
                conflictDates: conflictDates
            };
        }

        // Get total hours for resource on specific date
        function getTotalHoursForResourceOnDate(resourceId, date) {
            const dateStr = date.toISOString().split('T')[0];
            return bookings
                .filter(b => b.resourceId === resourceId && 
                           new Date(b.startDate).toISOString().split('T')[0] <= dateStr &&
                           new Date(b.endDate).toISOString().split('T')[0] >= dateStr)
                .reduce((total, b) => total + b.dailyHours, 0);
        }

        // Utility functions
        function isWorkingDay(date) {
            const day = date.getDay();
            return day !== 0 && day !== 6; // Not Sunday or Saturday
        }

        function getWorkingDaysBetween(startDate, endDate) {
            let count = 0;
            const currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                if (isWorkingDay(currentDate)) {
                    count++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return count;
        }

        // Show warning messages
        function showWarning(message, type = 'warning') {
            const container = document.getElementById('warningContainer');
            const warning = document.createElement('div');
            warning.className = `warning-message ${type}`;
            warning.innerHTML = `
                <span class="warning-icon">${type === 'error' ? '‚ö†Ô∏è' : type === 'success' ? '‚úÖ' : 'üí°'}</span>
                <span>${message}</span>
            `;
            
            container.innerHTML = '';
            container.appendChild(warning);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                warning.remove();
            }, 5000);
        }

        // Initialize Gantt chart
        function initializeGanttChart() {
            updateGanttChart();
        }

        // Update Gantt chart
        function updateGanttChart() {
            updateResourceList();
            updateTimelineHeader();
            updateResourceTimelines();
            updateCurrentPeriod();
            
            // Re-setup synchronized scrolling after DOM updates
            setTimeout(() => {
                setupSynchronizedScrolling();
            }, 100);
        }

        // Update resource list (supports both project and resource views)
        function updateResourceList() {
            if (currentViewMode === 'project') {
                updateResourceListByProject();
            } else {
                updateResourceListByResource();
            }
        }

        // Update resource list grouped by projects
        function updateResourceListByProject() {
            const container = document.getElementById('resourceList');
            container.innerHTML = '';
            
            projects.forEach(project => {
                // Get resources allocated to this project
                const projectResources = getResourcesForProject(project.id);
                
                // Skip projects with no resources
                if (projectResources.length === 0) return;
                
                // Create project group
                const projectGroup = document.createElement('div');
                projectGroup.className = 'project-group';
                
                // Create project header
                const projectHeader = document.createElement('div');
                projectHeader.className = `project-header ${project.expanded ? 'expanded' : ''}`;
                projectHeader.innerHTML = `
                    <div class="project-header-info">
                        <div class="project-expand-icon">‚ñ∂</div>
                        <div class="project-details">
                            <div class="project-name">${project.name}</div>
                            <div class="project-meta">${project.client} ‚Ä¢ <span class="project-status ${project.status.toLowerCase()}">${project.status}</span></div>
                        </div>
                    </div>
                `;
                
                // Add click handler for expand/collapse
                projectHeader.addEventListener('click', (e) => {
                    // Defensive: prevent any accidental navigation if nested links ever appear
                    e.preventDefault();
                    e.stopPropagation();
                    const beforeUrl = window.location.href;
                    const beforeProtocol = window.location.protocol;
                    console.log('[EXPAND PROJECT CLICK]', {
                        projectId: project.id,
                        name: project.name,
                        previousExpanded: project.expanded,
                        location: beforeUrl,
                        protocol: beforeProtocol
                    });
                    project.expanded = !project.expanded;
                    projectHeader.className = `project-header ${project.expanded ? 'expanded' : ''}`;
                    const resourcesContainer = projectGroup.querySelector('.project-resources');
                    resourcesContainer.className = `project-resources ${project.expanded ? 'expanded' : ''}`;
                    updateResourceTimelines(); // Update timelines to match
                    console.log('[EXPAND PROJECT AFTER]', { projectId: project.id, expanded: project.expanded });
                });
                
                projectGroup.appendChild(projectHeader);
                
                // Create resources container
                const resourcesContainer = document.createElement('div');
                resourcesContainer.className = `project-resources ${project.expanded ? 'expanded' : ''}`;
                
                // Add resources for this project
                projectResources.forEach(resource => {
                    const resourceElement = document.createElement('div');
                    resourceElement.className = `resource-row ${currentView === 'monthly' ? 'monthly-view' : ''}`;
                    resourceElement.innerHTML = `
                        <div class="resource-info project-resource-info">
                            <div class="resource-details">
                                <div class="resource-name">${resource.name}</div>
                                <div class="resource-capacity">Capacity: ${resource.capacity}h/day</div>
                            </div>
                        </div>
                    `;
                    resourcesContainer.appendChild(resourceElement);
                });
                
                projectGroup.appendChild(resourcesContainer);
                container.appendChild(projectGroup);
            });
        }

        // Update resource list grouped by resources (original view)
        function updateResourceListByResource() {
            console.log('updateResourceListByResource called');
            const container = document.getElementById('resourceList');
            if (!container) {
                console.error('resourceList container not found');
                return;
            }
            container.innerHTML = '';
            console.log('Processing', resources.length, 'resources');
            
            resources.forEach(resource => {
                // Calculate comprehensive utilization metrics for this resource
                const resourceBookings = bookings.filter(b => b.resourceId === resource.id);
                const allocationMetrics = calculateMaxConcurrentAllocation(resourceBookings, resource.id);
                const { maxConcurrentHours, totalPercentage, peakPercentage, peakDates, totalAllocationHours } = allocationMetrics;
                
                // Debug logging for John Smith
                if (resource.id === 1) {
                    console.log('John Smith Debug:', {
                        resourceBookings,
                        allocationMetrics,
                        maxConcurrentHours,
                        totalPercentage,
                        peakPercentage,
                        peakDates,
                        totalAllocationHours
                    });
                }
                
                // Main resource row
                const resourceElement = document.createElement('div');
                resourceElement.className = `resource-row ${currentView === 'monthly' ? 'monthly-view' : ''}`;
                
                const expandClass = resource.expanded ? 'expanded' : '';
                
                resourceElement.innerHTML = `
                    <div class="resource-info">
                        <div class="resource-expand-icon ${expandClass}" onclick="toggleResourceExpansion(${resource.id})">
                            ‚ñ∂
                        </div>
                        <div class="resource-details">
                            <div class="resource-name">${resource.name}</div>
                            <div class="resource-capacity">
                                Capacity: ${resource.capacity}h/day | 
                                Total: ${totalAllocationHours}h (${Math.round(totalPercentage)}%) | 
                                <span style="color: ${peakPercentage > 100 ? '#dc3545' : peakPercentage > 80 ? '#ffc107' : '#28a745'};">
                                    Peak: ${Math.round(peakPercentage)}% (${maxConcurrentHours}h) ${peakDates.length > 0 ? `on ${formatPeakDates(peakDates)}` : ''}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(resourceElement);
                
                // Add simplified project names when expanded (no icons, just names)
                if (resource.expanded && SHOW_RESOURCE_DETAIL_SUBROWS) {
                    const projectAllocations = getProjectAllocationsForResource(resource.id);
                    projectAllocations.forEach(allocation => {
                        const subRowElement = document.createElement('div');
                        subRowElement.className = 'resource-sub-row';
                        subRowElement.innerHTML = `
                            <div class="resource-info" style="padding-left: 40px;">
                                <div class="resource-details">
                                    <div class="resource-name" style="font-size: 13px; color: #6c757d;">
                                        ${allocation.project.name}
                                    </div>
                                </div>
                            </div>
                        `;
                        container.appendChild(subRowElement);
                    });
                }
            });
        }
        
        // Toggle resource expansion
        function toggleResourceExpansion(resourceId) {
            const resource = resources.find(r => r.id === resourceId);
            if (resource) {
                const beforeUrl = window.location.href;
                const beforeProtocol = window.location.protocol;
                console.log('[EXPAND RESOURCE CLICK]', {
                    resourceId,
                    name: resource.name,
                    previousExpanded: resource.expanded,
                    location: beforeUrl,
                    protocol: beforeProtocol
                });
                resource.expanded = !resource.expanded;
                updateGanttChart(); // Refresh the view
                console.log('[EXPAND RESOURCE AFTER]', { resourceId, expanded: resource.expanded });
            }
        }

        // Calculate maximum concurrent allocation for a resource
        function calculateMaxConcurrentAllocation(resourceBookings, resourceId = null) {
            if (resourceBookings.length === 0) return { 
                maxConcurrentHours: 0, 
                totalPercentage: 0, 
                peakPercentage: 0,
                peakDates: [],
                dailyBreakdown: {},
                totalAllocationHours: 0
            };
            
            const resource = resourceId ? resources.find(r => r.id === resourceId) : null;
            const dailyCapacity = resource ? resource.capacity : 8;
            
            // Create date-based allocation map and calculate totals
            const dailyAllocations = {};
            let totalAllocationHours = 0;
            
            resourceBookings.forEach(booking => {
                const bookingStart = new Date(booking.startDate);
                const bookingEnd = new Date(booking.endDate);
                const hours = booking.hours || booking.dailyHours || booking.allocationValue || 0;
                
                // Calculate total allocation hours (sum of all booking hours)
                const bookingDays = Math.ceil((bookingEnd - bookingStart) / (1000 * 60 * 60 * 24)) + 1;
                totalAllocationHours += hours * bookingDays;
                
                // Debug log for resource 1 (John Smith)
                if (resourceId === 1) {
                    console.log(`Booking ${booking.id}: ${bookingStart.toDateString()} to ${bookingEnd.toDateString()}, ${hours}h/day, ${bookingDays} days, total: ${hours * bookingDays}h`);
                }
                
                // Map daily concurrent allocations
                for (let date = new Date(bookingStart); date <= bookingEnd; date.setDate(date.getDate() + 1)) {
                    const dateKey = date.toISOString().split('T')[0];
                    if (!dailyAllocations[dateKey]) {
                        dailyAllocations[dateKey] = { hours: 0, projects: [] };
                    }
                    dailyAllocations[dateKey].hours += hours;
                    dailyAllocations[dateKey].projects.push({
                        projectId: booking.projectId,
                        projectName: projects.find(p => p.id === booking.projectId)?.name || 'Unknown',
                        hours: hours
                    });
                }
            });
            
            // Find maximum concurrent hours and peak dates
            const maxConcurrentHours = Math.max(...Object.values(dailyAllocations).map(d => d.hours));
            const peakDates = Object.entries(dailyAllocations)
                .filter(([date, allocation]) => allocation.hours === maxConcurrentHours)
                .map(([date]) => date)
                .sort();
            
            // Calculate percentages
            const peakPercentage = (maxConcurrentHours / dailyCapacity) * 100;
            
            // Total percentage based on total capacity across all allocated days
            const totalAllocatedDays = Object.keys(dailyAllocations).length;
            const totalCapacity = dailyCapacity * totalAllocatedDays;
            const totalPercentage = (totalAllocationHours / totalCapacity) * 100;
            
            // Create daily breakdown with percentages
            const dailyBreakdown = {};
            Object.entries(dailyAllocations).forEach(([date, allocation]) => {
                dailyBreakdown[date] = {
                    hours: allocation.hours,
                    percentage: (allocation.hours / dailyCapacity) * 100,
                    projects: allocation.projects
                };
            });
            
            // For backward compatibility, return maxConcurrentHours if called with old signature
            if (typeof arguments[0] === 'object' && arguments[1] === undefined) {
                return maxConcurrentHours;
            }
            
            return { 
                maxConcurrentHours, 
                totalPercentage: Math.min(totalPercentage, 100),
                peakPercentage: Math.min(peakPercentage, 100),
                peakDates,
                dailyBreakdown,
                totalAllocationHours
            };
        }

        // Format peak dates for display
        function formatPeakDates(peakDates) {
            if (peakDates.length === 0) return '';
            if (peakDates.length === 1) return new Date(peakDates[0]).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            
            // Check if dates are consecutive
            const dates = peakDates.map(d => new Date(d)).sort((a, b) => a - b);
            let isConsecutive = true;
            for (let i = 1; i < dates.length; i++) {
                const diffDays = (dates[i] - dates[i-1]) / (1000 * 60 * 60 * 24);
                if (diffDays !== 1) {
                    isConsecutive = false;
                    break;
                }
            }
            
            if (isConsecutive && dates.length > 1) {
                const start = dates[0].toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const end = dates[dates.length - 1].toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                return `${start}-${end}`;
            }
            
            // Non-consecutive dates
            if (dates.length <= 3) {
                return dates.map(d => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })).join(', ');
            } else {
                return `${dates.length} days`;
            }
        }

        // Get project allocations for a resource
        function getProjectAllocationsForResource(resourceId) {
            const allocations = {};
            
            bookings.filter(b => b.resourceId === resourceId).forEach(booking => {
                const project = projects.find(p => p.id === booking.projectId);
                if (project) {
                    if (!allocations[project.id]) {
                        allocations[project.id] = {
                            project: project,
                            totalHours: 0,
                            bookings: []
                        };
                    }
                    const hours = booking.hours || booking.dailyHours || booking.allocationValue || 0;
                    allocations[project.id].totalHours += hours;
                    allocations[project.id].bookings.push(booking);
                }
            });
            
            return Object.values(allocations);
        }

        // Helper function to get resources allocated to a project
        function getResourcesForProject(projectId) {
            const resourceIds = new Set();
            bookings.forEach(booking => {
                if (booking.projectId === projectId) {
                    resourceIds.add(booking.resourceId);
                }
            });
            
            return resources.filter(resource => resourceIds.has(resource.id));
        }

        // Update timeline header
        function updateTimelineHeader() {
            const header = document.getElementById('timelineHeader');
            const days = getDaysInCurrentView();
            
            // Only show month headers in daily and weekly views (not monthly to avoid duplication)
            const monthHeadersHTML = (currentView === 'monthly') ? '' : `<div class="timeline-months">${generateMonthHeaders(days)}</div>`;
            
            header.innerHTML = `
                ${monthHeadersHTML}
                <div class="timeline-days">${generateDayHeaders(days)}</div>
            `;
            
            // Update current period display
            updateCurrentPeriodDisplay();
        }
        
        // Update current period display
        function updateCurrentPeriodDisplay() {
            const startDateInput = document.getElementById('calendarStartDate').value;
            const endDateInput = document.getElementById('calendarEndDate').value;
            
            if (startDateInput && endDateInput) {
                const startDate = new Date(startDateInput);
                const endDate = new Date(endDateInput);
                const workingDays = getWorkingDaysBetween(startDate, endDate);
                
                const viewTypeText = {
                    'daily': 'Daily View',
                    'weekly': 'Weekly View', 
                    'monthly': 'Monthly View'
                };
                
                // Only update the calendar info since we removed the period element
                updateCalendarInfo(`üìä ${viewTypeText[currentView]} | ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()} | ${workingDays} working days`);
            } else {
                updateCalendarInfo('üìä Select date range to view resource allocations');
            }
        }

        // Update resource timelines (supports both project and resource views)
        function updateResourceTimelines() {
            if (currentViewMode === 'project') {
                updateResourceTimelinesByProject();
            } else {
                updateResourceTimelinesByResource();
            }
        }

        // Update resource timelines grouped by projects
        function updateResourceTimelinesByProject() {
            const container = document.getElementById('resourceTimelines');
            container.innerHTML = '';
            const days = getDaysInCurrentView();
            const dayWidth = calculateOptimalDayWidth(days.length); // Dynamic width for performance
            const totalWidth = days.length * dayWidth;
            
            projects.forEach(project => {
                const projectResources = getResourcesForProject(project.id);
                
                // Skip projects with no resources
                if (projectResources.length === 0) return;
                
                // Create project group for timeline
                const projectGroup = document.createElement('div');
                projectGroup.className = 'project-group';
                
                // Create project header timeline
                const projectHeaderTimeline = document.createElement('div');
                projectHeaderTimeline.className = `project-header ${project.expanded ? 'expanded' : ''}`;
                projectHeaderTimeline.innerHTML = `
                    <div class="resource-timeline" style="width: ${totalWidth}px; min-width: ${totalWidth}px; position: relative; background: #f8f9fa;">
                        ${generateTimelineGrid(days.length, dayWidth, days)}
                    </div>
                `;
                projectGroup.appendChild(projectHeaderTimeline);
                
                // Create resources timelines container
                const resourcesTimelinesContainer = document.createElement('div');
                resourcesTimelinesContainer.className = `project-resources ${project.expanded ? 'expanded' : ''}`;
                
                // Add timeline for each resource in this project
                projectResources.forEach(resource => {
                    const timelineElement = document.createElement('div');
                    timelineElement.className = `resource-row ${currentView === 'monthly' ? 'monthly-view' : ''}`;
                    timelineElement.innerHTML = `
                        <div class="resource-timeline" id="timeline-${project.id}-${resource.id}" style="width: ${totalWidth}px; min-width: ${totalWidth}px; position: relative;">
                            ${generateTimelineGrid(days.length, dayWidth, days)}
                            ${generateProjectBookingBars(resource.id, project.id, dayWidth)}
                            ${generateProjectAllocationNumbers(resource.id, project.id, dayWidth)}
                        </div>
                    `;
                    resourcesTimelinesContainer.appendChild(timelineElement);
                });
                
                projectGroup.appendChild(resourcesTimelinesContainer);
                container.appendChild(projectGroup);
            });
        }

        // Update resource timelines grouped by resources (original view)
        function updateResourceTimelinesByResource() {
            console.log('updateResourceTimelinesByResource called');
            const container = document.getElementById('resourceTimelines');
            if (!container) {
                console.error('resourceTimelines container not found');
                return;
            }
            container.innerHTML = '';
            const days = getDaysInCurrentView();
            console.log('Days in current view:', days.length);
            const dayWidth = calculateOptimalDayWidth(days.length); // Dynamic width for performance
            const totalWidth = days.length * dayWidth;
            console.log('Resources to render:', resources.length);
            
            resources.forEach(resource => {
                // Main resource timeline (collapsed state shows aggregated bars)
                const timelineElement = document.createElement('div');
                const monthlyViewClass = currentView === 'monthly' ? 'monthly-view' : '';
                
                timelineElement.className = `resource-row ${monthlyViewClass}`;
                
                const timelineGrid = generateTimelineGrid(days.length, dayWidth, days);
                const bookingBars = resource.expanded ? 
                    generateAggregatedBookingBars(resource.id, dayWidth) : // Collapsed: show aggregated
                    generateAggregatedBookingBars(resource.id, dayWidth);   // Same for now, will differentiate later
                
                timelineElement.innerHTML = `
                    <div class="resource-timeline" id="timeline-${resource.id}" style="width: ${totalWidth}px; min-width: ${totalWidth}px; position: relative;">
                        ${timelineGrid}
                        ${bookingBars}
                    </div>
                `;
                container.appendChild(timelineElement);
                
                // Add project-specific timelines if expanded
                if (resource.expanded && SHOW_RESOURCE_DETAIL_TIMELINES) {
                    const projectAllocations = getProjectAllocationsForResource(resource.id);
                    projectAllocations.forEach(allocation => {
                        const subTimelineElement = document.createElement('div');
                        subTimelineElement.className = 'resource-sub-row';
                        
                        const projectBookingBars = generateProjectSpecificBookingBars(resource.id, allocation.project.id, dayWidth);
                        
                        subTimelineElement.innerHTML = `
                            <div class="resource-timeline" style="width: ${totalWidth}px; min-width: ${totalWidth}px; position: relative;">
                                ${generateTimelineGrid(days.length, dayWidth, days)}
                                ${projectBookingBars}
                            </div>
                        `;
                        container.appendChild(subTimelineElement);
                    });
                }
            });
        }
        
        // Get available width for timeline container
        function getAvailableTimelineWidth() {
            const container = document.querySelector('.gantt-timeline');
            if (container) {
                return container.clientWidth - 20; // Account for padding/scrollbar
            }
            return window.innerWidth - 400; // Fallback: screen width minus sidebar
        }
        
        // Calculate responsive day width based on screen space and readability
        function calculateOptimalDayWidth(totalDays) {
            const availableWidth = getAvailableTimelineWidth();
            const minReadableWidth = getMinimumReadableWidth();
            
            // Calculate what width would fit on screen
            const responsiveWidth = Math.floor(availableWidth / totalDays);
            
            // Use responsive width if it's readable, otherwise use minimum readable width
            return Math.max(responsiveWidth, minReadableWidth);
        }
        
        // Get minimum readable width based on current view
        function getMinimumReadableWidth() {
            switch(currentView) {
                case 'daily':
                    return 40; // Minimum for readable day content
                case 'weekly':
                    return 80; // Minimum for readable week content
                case 'monthly':
                    return 120; // Minimum for readable month content
                default:
                    return 40;
            }
        }
        
        // Generate timeline grid for visual reference
        function generateTimelineGrid(dayCount, dayWidth, days) {
            let gridHtml = '';
            for (let i = 0; i < dayCount; i++) {
                const day = days[i];
                const isWeekend = day ? (day.getDay() === 0 || day.getDay() === 6) : false;
                const isToday = day ? (day.toDateString() === new Date().toDateString()) : false;
                
                let backgroundColor = '#fafafa';
                if (isToday) {
                    backgroundColor = '#e8f5e8';
                } else if (isWeekend && currentView === 'daily') {
                    // Only show yellow weekend highlighting in daily view
                    backgroundColor = '#fff3cd';
                }
                
                gridHtml += `<div class="timeline-grid-cell" style="
                    position: absolute; 
                    left: ${i * dayWidth}px; 
                    width: ${dayWidth}px; 
                    height: 50px; 
                    border-right: 1px solid #e9ecef; 
                    top: 0;
                    background: ${backgroundColor};
                    z-index: 1;
                    pointer-events: none;
                "></div>`;
            }
            return gridHtml;
        }

        // Generate booking bars for resource
        function generateBookingBars(resourceId, dayWidth = 60) {
            try {
                console.log(`generateBookingBars called for resource ${resourceId}`);
                const resourceBookings = bookings.filter(b => b.resourceId === resourceId);
                console.log(`Found ${resourceBookings.length} bookings for resource ${resourceId}`);
                const days = getDaysInCurrentView();
                let barsHtml = '';
                
                if (!days || days.length === 0) {
                    console.log('No days in current view');
                    return barsHtml;
                }
            
            // Process bookings and calculate their vertical positions
            const bookingBars = [];
            
            resourceBookings.forEach(booking => {
                const bookingStart = new Date(booking.startDate);
                const bookingEnd = new Date(booking.endDate);
                
                // Find overlapping days within current view
                let startIndex = -1;
                let endIndex = -1;
                
                for (let i = 0; i < days.length; i++) {
                    const currentDay = days[i];
                    const dayStr = currentDay.toDateString();
                    const bookingStartStr = bookingStart.toDateString();
                    const bookingEndStr = bookingEnd.toDateString();
                    
                    if (dayStr === bookingStartStr || (currentDay >= bookingStart && startIndex === -1)) {
                        startIndex = i;
                    }
                    if (dayStr === bookingEndStr || (currentDay <= bookingEnd && currentDay >= bookingStart)) {
                        endIndex = i;
                    }
                }
                
                if (startIndex !== -1 && endIndex !== -1 && startIndex <= endIndex) {
                    const left = (startIndex * dayWidth) + 4;
                    const width = ((endIndex - startIndex + 1) * dayWidth) - 8;
                    const project = projects.find(p => p.id === booking.projectId);
                    
                    if (project && width > 20) {
                        bookingBars.push({
                            booking,
                            project,
                            left,
                            width,
                            startIndex,
                            endIndex
                        });
                    }
                }
            });
            
            // Calculate vertical stacking positions to avoid overlaps
            const stackedBars = calculateVerticalStacking(bookingBars);
            console.log(`Resource ${resourceId}: stacked ${stackedBars.length} bars`);
            
            // Generate HTML for each stacked bar
            stackedBars.forEach(barInfo => {
                const { booking, project, left, width, verticalOffset } = barInfo;
                const hours = booking.hours || booking.dailyHours || booking.allocationValue || 0;
                const typeIcon = booking.type === 'hard' ? 'üîí' : 'üìù';
                const typeLabel = booking.type === 'hard' ? 'Confirmed' : 'Tentative';
                
                // Calculate utilization percentage for this booking
                const resource = resources.find(r => r.id === booking.resourceId);
                const capacity = resource ? resource.capacity : 8; // Default 8 hours
                const utilizationPercent = Math.min(Math.round((hours / capacity) * 100), 100);
                
                // Adjust bar height and font size based on current view
                const barHeight = currentView === 'monthly' ? 60 : 32;
                const fontSize = currentView === 'monthly' ? 14 : 11;
                const iconSize = currentView === 'monthly' ? 13 : 10;
                const padding = currentView === 'monthly' ? '0 16px' : '0 8px';
                
                // Store booking data in a global object for context menu access
                const bookingKey = `booking_${booking.id}`;
                window[bookingKey] = booking;
                
                barsHtml += `
                    <div class="booking-bar ${booking.type}" 
                         style="left: ${left}px; width: ${width}px; top: ${verticalOffset}px; z-index: 20; position: absolute; height: ${barHeight}px; display: flex; align-items: center; padding: ${padding}; cursor: pointer;"
                         title="${typeIcon} ${project.name} - ${typeLabel}\n${hours}h/day (${utilizationPercent}%) | ${booking.startDate} to ${booking.endDate}\n${booking.description || 'No description'}"
                         data-booking-id="${booking.id}"
                         oncontextmenu="showContextMenu(event, window['${bookingKey}'])">
                        <span style="font-size: ${fontSize}px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; gap: 4px;">
                            <span style="font-size: ${iconSize}px;">${typeIcon}</span>
                            <strong>${project.name}</strong>
                            <span style="opacity: 0.9;">(${hours}h)</span>
                        </span>
                        <div class="capacity-indicator" style="position: absolute; top: -8px; right: 2px; background: #007bff; color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px; font-weight: 700; z-index: 30; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 2px solid white;">
                            ${utilizationPercent}%
                        </div>
                    </div>
                `;
            });
            
            return barsHtml;
            } catch (error) {
                console.error('Error in generateBookingBars:', error);
                return '';
            }
        }

        // Calculate vertical stacking positions for overlapping booking bars
        function calculateVerticalStacking(bookingBars) {
            const barHeight = currentView === 'monthly' ? 65 : 37; // Include spacing
            const stackedBars = [];
            
            // Sort bars by start position for consistent stacking
            bookingBars.sort((a, b) => {
                if (a.startIndex !== b.startIndex) {
                    return a.startIndex - b.startIndex;
                }
                return a.endIndex - b.endIndex;
            });
            
            bookingBars.forEach(barInfo => {
                let verticalOffset = 0;
                let stackLevel = 0;
                
                // Check for overlaps with already positioned bars
                for (let existingBar of stackedBars) {
                    // Check if bars overlap horizontally
                    const overlap = !(barInfo.endIndex < existingBar.startIndex || barInfo.startIndex > existingBar.endIndex);
                    
                    if (overlap && existingBar.verticalOffset === verticalOffset) {
                        stackLevel++;
                        verticalOffset = stackLevel * barHeight;
                    }
                }
                
                stackedBars.push({
                    ...barInfo,
                    verticalOffset,
                    stackLevel
                });
            });
            
            return stackedBars;
        }

        // Calculate maximum stack level needed for a resource (for row height calculation)
        function getMaxStackLevelForResource(resourceId) {
            try {
                const resourceBookings = bookings.filter(b => b.resourceId === resourceId);
                const days = getDaysInCurrentView();
                
                if (!days || days.length === 0 || resourceBookings.length === 0) return 0;
            
            // Create booking bars data structure
            const bookingBars = [];
            resourceBookings.forEach(booking => {
                const bookingStart = new Date(booking.startDate);
                const bookingEnd = new Date(booking.endDate);
                
                let startIndex = -1;
                let endIndex = -1;
                
                for (let i = 0; i < days.length; i++) {
                    const currentDay = days[i];
                    if (currentDay >= bookingStart && startIndex === -1) {
                        startIndex = i;
                    }
                    if (currentDay <= bookingEnd && currentDay >= bookingStart) {
                        endIndex = i;
                    }
                }
                
                if (startIndex !== -1 && endIndex !== -1) {
                    bookingBars.push({
                        booking,
                        startIndex,
                        endIndex
                    });
                }
            });
            
            // Calculate stacking levels
            const stackedBars = calculateVerticalStacking(bookingBars);
            const maxLevel = stackedBars.reduce((max, bar) => Math.max(max, bar.stackLevel || 0), 0);
            
            return maxLevel;
            } catch (error) {
                console.error('Error in getMaxStackLevelForResource:', error);
                return 0;
            }
        }

        // Calculate required row height based on maximum stack level
        function calculateRowHeight(maxStackLevel) {
            const baseHeight = currentView === 'monthly' ? 85 : 50;
            const barHeight = currentView === 'monthly' ? 65 : 37;
            
            if (maxStackLevel === 0) {
                return baseHeight;
            }
            
            // Add space for additional stacked bars
            return baseHeight + (maxStackLevel * barHeight);
        }

        // Generate aggregated booking bars for collapsed resource view
        function generateAggregatedBookingBars(resourceId, dayWidth = 60) {
            try {
                const resourceBookings = bookings.filter(b => b.resourceId === resourceId);
                const days = getDaysInCurrentView();
                let barsHtml = '';
                
                if (!days || days.length === 0 || resourceBookings.length === 0) return barsHtml;
                
                // Group bookings by day to create aggregated bars
                const dailyAllocations = {};
                
                resourceBookings.forEach(booking => {
                    const bookingStart = new Date(booking.startDate);
                    const bookingEnd = new Date(booking.endDate);
                    const hours = booking.hours || booking.dailyHours || booking.allocationValue || 0;
                    
                    days.forEach((day, index) => {
                        if (day >= bookingStart && day <= bookingEnd) {
                            const dayKey = day.toISOString().split('T')[0];
                            if (!dailyAllocations[dayKey]) {
                                dailyAllocations[dayKey] = { totalHours: 0, dayIndex: index, projects: new Set() };
                            }
                            dailyAllocations[dayKey].totalHours += hours; // This is correct - we want total concurrent hours per day
                            dailyAllocations[dayKey].projects.add(booking.projectId);
                        }
                    });
                });
                
                // Create continuous bars for consecutive days
                const allocatedDays = Object.keys(dailyAllocations).sort();
                if (allocatedDays.length === 0) return barsHtml;
                
                let currentStart = -1;
                let currentEnd = -1;
                let currentTotalHours = 0;
                let currentProjects = new Set();
                
                allocatedDays.forEach((dayKey, index) => {
                    const allocation = dailyAllocations[dayKey];
                    const dayIndex = allocation.dayIndex;
                    
                    if (currentStart === -1) {
                        // Start new bar
                        currentStart = dayIndex;
                        currentEnd = dayIndex;
                        currentTotalHours = allocation.totalHours;
                        currentProjects = new Set(allocation.projects);
                    } else if (dayIndex === currentEnd + 1) {
                        // Continue current bar
                        currentEnd = dayIndex;
                        currentTotalHours = Math.max(currentTotalHours, allocation.totalHours); // Use max for display
                        allocation.projects.forEach(p => currentProjects.add(p));
                    } else {
                        // End current bar and start new one
                        barsHtml += generateAggregatedBar(resourceId, currentStart, currentEnd, currentTotalHours, currentProjects, dayWidth);
                        currentStart = dayIndex;
                        currentEnd = dayIndex;
                        currentTotalHours = allocation.totalHours;
                        currentProjects = new Set(allocation.projects);
                    }
                });
                
                // Add final bar
                if (currentStart !== -1) {
                    barsHtml += generateAggregatedBar(resourceId, currentStart, currentEnd, currentTotalHours, currentProjects, dayWidth);
                }
                
                return barsHtml;
            } catch (error) {
                console.error('Error in generateAggregatedBookingBars:', error);
                return '';
            }
        }

        // Generate single aggregated bar
        function generateAggregatedBar(resourceId, startIndex, endIndex, totalHours, projectIds, dayWidth) {
            const left = (startIndex * dayWidth) + 4;
            const width = ((endIndex - startIndex + 1) * dayWidth) - 8;
            
            const resource = resources.find(r => r.id === resourceId);
            const capacity = resource ? resource.capacity : 8;
            const utilizationPercent = Math.min(Math.round((totalHours / capacity) * 100), 100);
            
            // Determine bar color based on utilization
            let barColor = '#28a745'; // Green
            if (utilizationPercent > 100) barColor = '#dc3545'; // Red
            else if (utilizationPercent > 80) barColor = '#ffc107'; // Yellow
            
            const barHeight = currentView === 'monthly' ? 60 : 32;
            const fontSize = currentView === 'monthly' ? 14 : 11;
            const padding = currentView === 'monthly' ? '0 16px' : '0 8px';
            
            const projectCount = projectIds.size;
            const projectText = projectCount === 1 ? '1 project' : `${projectCount} projects`;
            
            return `
                <div class="booking-bar aggregated" 
                     style="left: ${left}px; width: ${width}px; z-index: 20; position: absolute; height: ${barHeight}px; display: flex; align-items: center; padding: ${padding}; background: ${barColor}; border-radius: 4px; min-width: 60px;"
                     title="Concurrent Allocation: ${totalHours}h/day (${utilizationPercent}% of ${capacity}h capacity) across ${projectText}">
                    <span style="font-size: ${fontSize}px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: white; font-weight: 600; max-width: calc(100% - 8px);">
                        ${totalHours}h
                    </span>
                    <div class="capacity-indicator" style="position: absolute; top: -6px; right: 2px; background: rgba(255,255,255,0.9); color: #374151; padding: 1px 4px; border-radius: 8px; font-size: 9px; font-weight: 600; z-index: 30; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                        ${utilizationPercent}%
                    </div>
                </div>
            `;
        }

        // Generate project-specific booking bars for expanded view
        function generateProjectSpecificBookingBars(resourceId, projectId, dayWidth = 60) {
            const projectBookings = bookings.filter(b => b.resourceId === resourceId && b.projectId === projectId);
            const days = getDaysInCurrentView();
            let barsHtml = '';
            
            if (!days || days.length === 0 || projectBookings.length === 0) return barsHtml;
            
            const project = projects.find(p => p.id === projectId);
            if (!project) return barsHtml;
            
            projectBookings.forEach(booking => {
                const bookingStart = new Date(booking.startDate);
                const bookingEnd = new Date(booking.endDate);
                
                let startIndex = -1;
                let endIndex = -1;
                
                for (let i = 0; i < days.length; i++) {
                    const currentDay = days[i];
                    if (currentDay >= bookingStart && startIndex === -1) {
                        startIndex = i;
                    }
                    if (currentDay <= bookingEnd && currentDay >= bookingStart) {
                        endIndex = i;
                    }
                }
                
                if (startIndex !== -1 && endIndex !== -1) {
                    const left = (startIndex * dayWidth) + 4;
                    const width = ((endIndex - startIndex + 1) * dayWidth) - 8;
                    const hours = booking.hours || booking.dailyHours || booking.allocationValue || 0;
                    const typeIcon = booking.type === 'hard' ? 'üîí' : 'üìù';
                    
                    const resource = resources.find(r => r.id === resourceId);
                    const capacity = resource ? resource.capacity : 8;
                    const utilizationPercent = Math.min(Math.round((hours / capacity) * 100), 100);
                    
                    const barHeight = currentView === 'monthly' ? 60 : 32;
                    const fontSize = currentView === 'monthly' ? 12 : 10;
                    const padding = currentView === 'monthly' ? '0 12px' : '0 6px';
                    
                    // Store booking data for context menu
                    const bookingKey = `booking_${booking.id}`;
                    window[bookingKey] = booking;
                    
                    barsHtml += `
                        <div class="booking-bar ${booking.type}" 
                             style="left: ${left}px; width: ${width}px; z-index: 20; position: absolute; height: ${barHeight}px; display: flex; align-items: center; padding: ${padding}; opacity: 0.8; cursor: pointer;"
                             title="${typeIcon} ${project.name}\n${hours}h/day (${utilizationPercent}%) | ${bookingStart.toLocaleDateString()} to ${bookingEnd.toLocaleDateString()}"
                             data-booking-id="${booking.id}"
                             oncontextmenu="showContextMenu(event, window['${bookingKey}'])">
                            <span style="font-size: ${fontSize}px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: white; font-weight: 500;">
                                ${typeIcon} ${hours}h
                            </span>
                            <div class="capacity-indicator" style="position: absolute; top: -6px; right: 2px; background: rgba(0,123,255,0.9); color: white; padding: 1px 4px; border-radius: 8px; font-size: 8px; font-weight: 600; z-index: 25;">
                                ${utilizationPercent}%
                            </div>
                        </div>
                    `;
                }
            });
            
            return barsHtml;
        }

        // Generate booking bars for resource within a specific project (no overlapping)
        function generateProjectBookingBars(resourceId, projectId, dayWidth = 60) {
            const resourceProjectBookings = bookings.filter(b => b.resourceId === resourceId && b.projectId === projectId);
            const days = getDaysInCurrentView();
            let barsHtml = '';
            
            if (!days || days.length === 0) return barsHtml;
            
            resourceProjectBookings.forEach(booking => {
                const bookingStart = new Date(booking.startDate);
                const bookingEnd = new Date(booking.endDate);
                
                // Find overlapping days within current view
                let startIndex = -1;
                let endIndex = -1;
                
                for (let i = 0; i < days.length; i++) {
                    const currentDay = days[i];
                    const dayStr = currentDay.toDateString();
                    const bookingStartStr = bookingStart.toDateString();
                    const bookingEndStr = bookingEnd.toDateString();
                    
                    if (dayStr === bookingStartStr || (currentDay >= bookingStart && startIndex === -1)) {
                        startIndex = i;
                    }
                    if (dayStr === bookingEndStr || (currentDay <= bookingEnd && currentDay >= bookingStart)) {
                        endIndex = i;
                    }
                }
                
                if (startIndex !== -1 && endIndex !== -1 && startIndex <= endIndex) {
                    const left = (startIndex * dayWidth) + 4;
                    const width = ((endIndex - startIndex + 1) * dayWidth) - 8;
                    const project = projects.find(p => p.id === booking.projectId);
                    
                    if (project && width > 20) { // Only show if wide enough
                        const hours = booking.hours || booking.dailyHours || booking.allocationValue || 0;
                        const typeIcon = booking.type === 'hard' ? 'üîí' : 'üìù';
                        const typeLabel = booking.type === 'hard' ? 'Confirmed' : 'Tentative';
                        
                        // Calculate utilization percentage for this booking
                        const resource = resources.find(r => r.id === booking.resourceId);
                        const capacity = resource ? resource.capacity : 8; // Default 8 hours
                        const utilizationPercent = Math.min(Math.round((hours / capacity) * 100), 100);
                        
                        // Adjust bar height and font size based on current view
                        const barHeight = currentView === 'monthly' ? 60 : 32;
                        const fontSize = currentView === 'monthly' ? 16 : 12;
                        const iconSize = currentView === 'monthly' ? 14 : 10;
                        const padding = currentView === 'monthly' ? '0 16px' : '0 8px';
                        
                        // Store booking data for context menu
                        const bookingKey = `booking_${booking.id}`;
                        window[bookingKey] = booking;
                        
                        barsHtml += `
                            <div class="booking-bar ${booking.type}" 
                                 style="left: ${left}px; width: ${width}px; z-index: 20; position: absolute; height: ${barHeight}px; display: flex; align-items: center; justify-content: center; padding: ${padding}; cursor: pointer;"
                                 title="${typeIcon} ${booking.description || 'Task'} - ${typeLabel}\n${hours}h/day (${utilizationPercent}%) | ${bookingStart.toLocaleDateString()} to ${bookingEnd.toLocaleDateString()}"
                                 data-booking-id="${booking.id}"
                                 oncontextmenu="showContextMenu(event, window['${bookingKey}'])">
                                <span style="font-size: ${fontSize}px; font-weight: 700; display: flex; align-items: center; gap: 2px;">
                                    <span style="font-size: ${iconSize}px;">${typeIcon}</span>
                                    ${hours}h
                                </span>
                                <div class="capacity-indicator" style="position: absolute; top: -8px; right: 2px; background: #007bff; color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px; font-weight: 700; z-index: 30; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 2px solid white;">
                                    ${utilizationPercent}%
                                </div>
                            </div>
                        `;
                    }
                }
            });
            
            return barsHtml;
        }

        // Generate allocation numbers for project view based on view type
        function generateProjectAllocationNumbers(resourceId, projectId, dayWidth = 60) {
            const resourceProjectBookings = bookings.filter(b => b.resourceId === resourceId && b.projectId === projectId);
            const days = getDaysInCurrentView();
            let numbersHtml = '';
            
            if (!days || days.length === 0) return numbersHtml;
            
            // Generate numbers based on view type
            days.forEach((period, index) => {
                let allocation = 0;
                
                switch(currentView) {
                    case 'daily':
                        // Daily view - show hours per day (excluding weekends)
                        allocation = calculateDailyAllocation(resourceProjectBookings, period);
                        break;
                        
                    case 'weekly':
                        // Weekly view - show total hours for the week (excluding weekends)
                        allocation = calculateWeeklyAllocation(resourceProjectBookings, period);
                        break;
                        
                    case 'monthly':
                        // Monthly view - show total hours for the month (excluding weekends)
                        allocation = calculateMonthlyAllocation(resourceProjectBookings, period);
                        break;
                }
                
                if (allocation && allocation > 0) {
                    const left = (index * dayWidth) + (dayWidth / 2) - 12;
                    const isOverAllocated = (currentView === 'daily' && allocation > 8) || 
                                          (currentView === 'weekly' && allocation > 40) || 
                                          (currentView === 'monthly' && allocation > 160);
                    const badgeClass = isOverAllocated ? 'over-allocated' : '';
                    const suffix = currentView === 'daily' ? 'h' : currentView === 'weekly' ? 'h/w' : 'h/m';
                    
                    numbersHtml += `
                        <div class="allocation-number ${badgeClass}" 
                             style="left: ${left}px; position: absolute; top: 50%; transform: translateY(-50%); z-index: 25; pointer-events: none;"
                             title="${currentView} allocation: ${allocation} hours${isOverAllocated ? ' (Over-allocated!)' : ''}">
                            ${allocation}${suffix}
                        </div>
                    `;
                }
            });
            
            return numbersHtml;
        }
        
        // Calculate daily allocation (excluding weekends)
        function calculateDailyAllocation(bookings, day) {
            let totalHours = 0;
            const dayKey = day.toDateString();
            
            bookings.forEach(booking => {
                const bookingStart = new Date(booking.startDate);
                const bookingEnd = new Date(booking.endDate);
                const hours = booking.hours || booking.dailyHours || booking.allocationValue || 0;
                
                if (day >= bookingStart && day <= bookingEnd) {
                    const dayOfWeek = day.getDay();
                    // Only count working days (Monday to Friday)
                    if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                        totalHours += hours;
                    }
                }
            });
            
            return totalHours;
        }
        
        // Calculate weekly allocation (excluding weekends)
        function calculateWeeklyAllocation(bookings, weekStart) {
            let totalHours = 0;
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            bookings.forEach(booking => {
                const bookingStart = new Date(booking.startDate);
                const bookingEnd = new Date(booking.endDate);
                const hours = booking.hours || booking.dailyHours || booking.allocationValue || 0;
                
                // Count working days in the overlap between booking and week
                const overlapStart = new Date(Math.max(bookingStart.getTime(), weekStart.getTime()));
                const overlapEnd = new Date(Math.min(bookingEnd.getTime(), weekEnd.getTime()));
                
                if (overlapStart <= overlapEnd) {
                    const currentDay = new Date(overlapStart);
                    while (currentDay <= overlapEnd) {
                        const dayOfWeek = currentDay.getDay();
                        // Only count working days (Monday to Friday)
                        if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                            totalHours += hours;
                        }
                        currentDay.setDate(currentDay.getDate() + 1);
                    }
                }
            });
            
            return totalHours;
        }
        
        // Calculate monthly allocation (excluding weekends)
        function calculateMonthlyAllocation(bookings, monthStart) {
            let totalHours = 0;
            const monthEnd = new Date(monthStart.getFullYear(), monthStart.getMonth() + 1, 0);
            
            bookings.forEach(booking => {
                const bookingStart = new Date(booking.startDate);
                const bookingEnd = new Date(booking.endDate);
                const hours = booking.hours || booking.dailyHours || booking.allocationValue || 0;
                
                // Count working days in the overlap between booking and month
                const overlapStart = new Date(Math.max(bookingStart.getTime(), monthStart.getTime()));
                const overlapEnd = new Date(Math.min(bookingEnd.getTime(), monthEnd.getTime()));
                
                if (overlapStart <= overlapEnd) {
                    const currentDay = new Date(overlapStart);
                    while (currentDay <= overlapEnd) {
                        const dayOfWeek = currentDay.getDay();
                        // Only count working days (Monday to Friday)
                        if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                            totalHours += hours;
                        }
                        currentDay.setDate(currentDay.getDate() + 1);
                    }
                }
            });
            
            return totalHours;
        }

        // Generate capacity indicators for resource view
        function generateCapacityIndicators(resourceId, capacity, dayWidth = 60) {
            // Don't generate separate capacity indicators - they should be part of the booking bars
            // This function will be used differently - to add indicators to existing booking bars
            return '';
        }

        // Get days in current view based on selected date range and view type
        function getDaysInCurrentView() {
            const startDateInput = document.getElementById('calendarStartDate').value;
            const endDateInput = document.getElementById('calendarEndDate').value;
            
            if (!startDateInput || !endDateInput) {
                // Fallback to default range if no dates selected
                return getDefaultDaysInCurrentView();
            }
            
            // Validate date range
            if (!validateCalendarDateRange()) {
                return getDefaultDaysInCurrentView();
            }
            
            const startDate = new Date(startDateInput);
            const endDate = new Date(endDateInput);
            const days = [];
            
            switch(currentView) {
                case 'daily':
                    // Show all days including weekends (but weekends will be disabled for bookings)
                    const currentDate = new Date(startDate);
                    const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                    
                    // Performance optimization: For very large ranges (>90 days), consider chunking
                    if (daysDiff > 90) {
                        // For large ranges, we'll still show all days but optimize rendering
                        while (currentDate <= endDate) {
                            days.push(new Date(currentDate));
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                    } else {
                        // Normal range processing
                        while (currentDate <= endDate) {
                            days.push(new Date(currentDate));
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                    }
                    break;
                    
                case 'weekly':
                    // Group by weeks, show week periods
                    const weekStart = new Date(startDate);
                    // Move to Monday of the start week
                    const startDayOfWeek = weekStart.getDay();
                    const mondayOffset = startDayOfWeek === 0 ? -6 : 1 - startDayOfWeek;
                    weekStart.setDate(weekStart.getDate() + mondayOffset);
                    
                    const currentWeek = new Date(weekStart);
                    while (currentWeek <= endDate) {
                        days.push(new Date(currentWeek));
                        currentWeek.setDate(currentWeek.getDate() + 7);
                    }
                    break;
                    
                case 'monthly':
                    // Group by months, show month periods
                    const monthStart = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
                    const currentMonth = new Date(monthStart);
                    
                    while (currentMonth <= endDate) {
                        days.push(new Date(currentMonth));
                        currentMonth.setMonth(currentMonth.getMonth() + 1);
                    }
                    break;
            }
            
            return days;
        }
        
        // Fallback for default days view
        function getDefaultDaysInCurrentView() {
            const days = [];
            const startDate = getViewStartDate();
            const endDate = getViewEndDate();
            
            const currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                const dayOfWeek = currentDate.getDay();
                // Include only Monday (1) to Friday (5) for default view too
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    days.push(new Date(currentDate));
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return days;
        }

        // Get view start date
        function getViewStartDate() {
            const date = new Date(currentDate);
            
            switch(currentView) {
                case 'daily':
                    // Show 14 days from current date
                    return new Date(date);
                case 'weekly':
                    // Show start of current week (Monday)
                    const dayOfWeek = date.getDay();
                    const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Handle Sunday as 0
                    date.setDate(date.getDate() + mondayOffset);
                    return new Date(date);
                case 'monthly':
                    // Show start of current month
                    date.setDate(1);
                    return new Date(date);
                default:
                    return new Date(date);
            }
        }

        // Get view end date
        function getViewEndDate() {
            const startDate = getViewStartDate();
            const endDate = new Date(startDate);
            
            switch(currentView) {
                case 'daily':
                    endDate.setDate(endDate.getDate() + 13); // 14 days total
                    break;
                case 'weekly':
                    endDate.setDate(endDate.getDate() + 27); // 4 weeks (28 days)
                    break;
                case 'monthly':
                    endDate.setMonth(endDate.getMonth() + 3); // 3 months ahead
                    endDate.setDate(endDate.getDate() - 1); // Last day of previous month
                    break;
            }
            
            return endDate;
        }

        // Generate week headers with week numbers
        function generateWeekHeaders(days) {
            if (!days || days.length === 0) return '';
            
            let html = '';
            let currentWeek = '';
            let weekStart = 0;
            const dayWidth = 60;
            
            days.forEach((day, index) => {
                // Get ISO week number
                const weekNumber = getISOWeekNumber(day);
                const weekLabel = `W${weekNumber}`;
                
                if (weekLabel !== currentWeek) {
                    if (currentWeek) {
                        const width = (index - weekStart) * dayWidth;
                        html += `<div class="timeline-week" style="width: ${width}px; min-width: ${width}px; flex-shrink: 0;">${currentWeek}</div>`;
                    }
                    currentWeek = weekLabel;
                    weekStart = index;
                }
            });
            
            // Add last week
            if (currentWeek) {
                const width = (days.length - weekStart) * dayWidth;
                html += `<div class="timeline-week" style="width: ${width}px; min-width: ${width}px; flex-shrink: 0;">${currentWeek}</div>`;
            }
            
            return html;
        }
        
        // Get ISO week number
        function getISOWeekNumber(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            // Set to nearest Thursday: current date + 4 - current day number
            // Make Sunday's day number 7
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            // Get first day of year
            const yearStart = new Date(d.getFullYear(), 0, 1);
            // Calculate full weeks to nearest Thursday
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }

        // Generate month headers
        function generateMonthHeaders(days) {
            if (!days || days.length === 0) return '';
            
            let html = '';
            let currentMonth = '';
            let monthStart = 0;
            const dayWidth = calculateOptimalDayWidth(days.length);
            
            days.forEach((day, index) => {
                const monthName = day.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                if (monthName !== currentMonth) {
                    if (currentMonth) {
                        const width = (index - monthStart) * dayWidth;
                        html += `<div class="timeline-month" style="width: ${width}px; min-width: ${width}px; flex-shrink: 0;">${currentMonth}</div>`;
                    }
                    currentMonth = monthName;
                    monthStart = index;
                }
            });
            
            // Add last month
            if (currentMonth) {
                const width = (days.length - monthStart) * dayWidth;
                html += `<div class="timeline-month" style="width: ${width}px; min-width: ${width}px; flex-shrink: 0;">${currentMonth}</div>`;
            }
            
            return html;
        }

        // Generate headers based on current view type
        function generateDayHeaders(days) {
            if (!days || days.length === 0) return '';
            
            const dayWidth = calculateOptimalDayWidth(days.length);
            
            switch(currentView) {
                case 'daily':
                    return days.map(day => {
                        const isToday = day.toDateString() === new Date().toDateString();
                        const dayNumber = day.getDate();
                        const dayName = day.toLocaleDateString('en-US', { weekday: 'short' });
                        
                        return `<div style="
                            width: ${dayWidth}px; 
                            min-width: ${dayWidth}px; 
                            border-right: 1px solid #e9ecef;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            font-size: 12px;
                            font-weight: 500;
                            background: ${isToday ? '#e8f5e8' : '#fafafa'};
                            flex-shrink: 0;
                            padding: 4px 2px;
                        ">
                            <div style="font-size: 10px; line-height: 1; color: #6c757d;">${dayName}</div>
                            <div style="font-size: 12px; font-weight: 600; color: ${isToday ? '#155724' : '#495057'};">${dayNumber}</div>
                        </div>`;
                    }).join('');
                    
                case 'weekly':
                    return days.map(weekStart => {
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekEnd.getDate() + 6);
                        const weekNumber = getISOWeekNumber(weekStart);
                        
                        return `<div style="
                            width: ${dayWidth}px; 
                            min-width: ${dayWidth}px; 
                            border-right: 1px solid #e9ecef;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            font-size: 12px;
                            font-weight: 500;
                            background: #fafafa;
                            flex-shrink: 0;
                            padding: 4px 2px;
                        ">
                            <div style="font-size: 10px; line-height: 1; color: #6c757d;">Week ${weekNumber}</div>
                            <div style="font-size: 11px; font-weight: 600; color: #495057;">${weekStart.getDate()}-${weekEnd.getDate()}</div>
                        </div>`;
                    }).join('');
                    
                case 'monthly':
                    return days.map(monthStart => {
                        const monthName = monthStart.toLocaleDateString('en-US', { month: 'short' });
                        const year = monthStart.getFullYear();
                        
                        return `<div style="
                            width: ${dayWidth}px; 
                            min-width: ${dayWidth}px; 
                            border-right: 1px solid #e9ecef;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            font-size: 12px;
                            font-weight: 500;
                            background: #fafafa;
                            flex-shrink: 0;
                            padding: 4px 2px;
                        ">
                            <div style="font-size: 10px; line-height: 1; color: #6c757d;">${monthName}</div>
                            <div style="font-size: 12px; font-weight: 600; color: #495057;">${year}</div>
                        </div>`;
                    }).join('');
                    
                default:
                    return '';
            }
        }

        // Navigate timeframe
        function navigateTimeframe(direction) {
            switch(currentView) {
                case 'daily':
                    currentDate.setDate(currentDate.getDate() + (direction * 14));
                    break;
                case 'weekly':
                    currentDate.setDate(currentDate.getDate() + (direction * 28));
                    break;
                case 'monthly':
                    currentDate.setMonth(currentDate.getMonth() + (direction * 3));
                    break;
            }
            
            updateGanttChart();
        }

        // Update current period display
        function updateCurrentPeriod() {
            // Function kept for compatibility but currentPeriod element removed
            // Period information is now shown in calendarDateInfo only
        }

        // Add sample bookings
        // Sample bookings function removed - now using real API data

        // Context Menu Variables
        let selectedBooking = null;
        let currentEditAllocationMethod = 'hours';

        // Show context menu on right click
        function showContextMenu(event, bookingData) {
            event.preventDefault();
            event.stopPropagation();
            
            console.log('=== Context Menu Debug ===');
            console.log('Raw booking data:', bookingData);
            console.log('Booking data type:', typeof bookingData);
            
            // Parse booking data if it's a string
            selectedBooking = typeof bookingData === 'string' ? JSON.parse(bookingData.replace(/&quot;/g, '"')) : bookingData;
            
            console.log('Parsed selected booking:', selectedBooking);
            console.log('Has apiId:', selectedBooking ? selectedBooking.apiId : 'no booking');
            console.log('=== End Context Menu Debug ===');
            
            const contextMenu = document.getElementById('contextMenu');
            
            // Get the allocation bar element
            const allocationBar = event.currentTarget;
            const barRect = allocationBar.getBoundingClientRect();
            
            // Position menu relative to the allocation bar
            const menuWidth = 180;
            const menuHeight = 120;
            
            // Position to the right of the bar, or left if not enough space
            let x = barRect.right + 10;
            if (x + menuWidth > window.innerWidth) {
                x = barRect.left - menuWidth - 10;
            }
            
            // Position below the bar, or above if not enough space
            let y = barRect.bottom + 5;
            if (y + menuHeight > window.innerHeight) {
                y = barRect.top - menuHeight - 5;
            }
            
            // Ensure menu stays within viewport
            x = Math.max(10, Math.min(x, window.innerWidth - menuWidth - 10));
            y = Math.max(10, Math.min(y, window.innerHeight - menuHeight - 10));
            
            contextMenu.style.left = `${x}px`;
            contextMenu.style.top = `${y}px`;
            contextMenu.style.display = 'block';
            
            // Update the status toggle text
            const toggleButton = contextMenu.querySelector('button:nth-child(2)');
            const currentStatus = selectedBooking.type === 'hard' ? 'Hard' : 'Soft';
            const newStatus = selectedBooking.type === 'hard' ? 'Soft' : 'Hard';
            toggleButton.innerHTML = `üîÑ Change to ${newStatus} Booking`;
            
            console.log('Context menu shown for booking:', selectedBooking);
        }

        // Hide context menu
        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
            selectedBooking = null;
        }

        // Edit booking function
        function editBooking() {
            hideContextMenu();
            if (!selectedBooking) return;
            
            // Populate edit form with current booking data
            document.getElementById('editProjectSelect').value = selectedBooking.projectId;
            document.getElementById('editResourceSelect').value = selectedBooking.resourceId;
            document.getElementById('editStartDate').value = selectedBooking.startDate.toISOString().split('T')[0];
            document.getElementById('editEndDate').value = selectedBooking.endDate.toISOString().split('T')[0];
            document.getElementById('editAllocationValue').value = selectedBooking.allocationValue;
            
            // Set allocation method
            setEditAllocationMethod(selectedBooking.allocationMethod);
            
            // Set booking type
            document.querySelector(`input[name="editBookingType"][value="${selectedBooking.type}"]`).checked = true;
            
            // Populate dropdowns
            populateEditDropdowns();
            
            // Show modal
            document.getElementById('editModal').style.display = 'block';
        }

        // Toggle booking status (Hard ‚Üî Soft)
        async function toggleBookingStatus() {
            hideContextMenu();
            if (!selectedBooking) {
                console.error('No booking selected for status toggle');
                return;
            }
            
            const newStatus = selectedBooking.type === 'hard' ? 'soft' : 'hard';
            const statusText = newStatus === 'hard' ? 'Hard' : 'Soft';
            
            console.log('Toggling booking status:', selectedBooking, 'from', selectedBooking.type, 'to', newStatus);
            
            try {
                // Check if we have an API ID for the booking
                if (!selectedBooking.apiId) {
                    console.warn('No apiId found, updating local array only');
                    // Update local booking data
                    selectedBooking.type = newStatus;
                    
                    // Update the booking in the bookings array
                    const bookingIndex = bookings.findIndex(b => b.id === selectedBooking.id);
                    if (bookingIndex !== -1) {
                        bookings[bookingIndex].type = newStatus;
                    }
                    
                    updateGanttChart();
                    showWarning(`Booking status changed to ${statusText}!`, 'success');
                    return;
                }
                
                // Update booking status via API
                const response = await makeAuthenticatedRequest(`${API_URL}/resource-planning/bookings/${selectedBooking.apiId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...selectedBooking,
                        type: newStatus
                    })
                });
                
                if (response.ok) {
                    // Update local booking data
                    selectedBooking.type = newStatus;
                    
                    // Update the booking in the bookings array
                    const bookingIndex = bookings.findIndex(b => b.id === selectedBooking.id);
                    if (bookingIndex !== -1) {
                        bookings[bookingIndex].type = newStatus;
                    }
                    
                    // Refresh the visualization
                    updateGanttChart();
                    
                    showWarning(`Booking status changed to ${statusText} successfully!`, 'success');
                } else {
                    const error = await response.json();
                    console.error('API status update error:', error);
                    showWarning(`Failed to update booking status: ${error.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Error updating booking status:', error);
                showWarning('Error updating booking status. Please try again.', 'error');
            }
        }

        // Delete booking function
        async function deleteBooking() {
            hideContextMenu();
            if (!selectedBooking) {
                console.error('No booking selected for deletion');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this booking? This action cannot be undone.')) {
                return;
            }
            
            console.log('Deleting booking:', selectedBooking);
            
            try {
                // Check if we have an API ID for the booking
                if (!selectedBooking.apiId) {
                    console.warn('No apiId found, removing from local array only');
                    // Remove from local bookings array only
                    bookings = bookings.filter(b => b.id !== selectedBooking.id);
                    updateGanttChart();
                    showWarning('Booking removed from display!', 'success');
                    return;
                }
                
                // Delete booking via API
                const response = await makeAuthenticatedRequest(`${API_URL}/resource-planning/bookings/${selectedBooking.apiId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Remove from local bookings array
                    bookings = bookings.filter(b => b.id !== selectedBooking.id);
                    
                    // Refresh the visualization
                    updateGanttChart();
                    
                    showWarning('Booking deleted successfully!', 'success');
                } else {
                    const error = await response.json();
                    console.error('API delete error:', error);
                    showWarning(`Failed to delete booking: ${error.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting booking:', error);
                showWarning('Error deleting booking. Please try again.', 'error');
            }
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // Set edit allocation method
        function setEditAllocationMethod(method) {
            currentEditAllocationMethod = method;
            document.querySelectorAll('#editModal .allocation-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const input = document.getElementById('editAllocationValue');
            switch(method) {
                case 'hours':
                    input.placeholder = 'Hours per day';
                    input.max = '8';
                    input.step = '0.5';
                    break;
                case 'percentage':
                    input.placeholder = 'Percentage (0-100)';
                    input.max = '100';
                    input.step = '5';
                    break;
                case 'total':
                    input.placeholder = 'Total hours';
                    input.max = '1000';
                    input.step = '1';
                    break;
            }
        }

        // Populate edit form dropdowns
        function populateEditDropdowns() {
            const resourceSelect = document.getElementById('editResourceSelect');
            const projectSelect = document.getElementById('editProjectSelect');
            
            // Populate resources - show only names
            resourceSelect.innerHTML = '<option value="">Select Resource...</option>';
            resources.forEach(resource => {
                const option = document.createElement('option');
                option.value = resource.id;
                option.textContent = resource.name; // Show only name
                resourceSelect.appendChild(option);
            });
            
            // Populate projects - show only names
            projectSelect.innerHTML = '<option value="">Select Project...</option>';
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name; // Show only name
                projectSelect.appendChild(option);
            });
        }

        // Handle edit form submission (only if element exists)
        const editBookingForm = document.getElementById('editBookingForm');
        if (editBookingForm) {
            editBookingForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const resourceId = document.getElementById('editResourceSelect').value;
                const projectId = document.getElementById('editProjectSelect').value;
                const startDate = new Date(document.getElementById('editStartDate').value);
                const endDate = new Date(document.getElementById('editEndDate').value);
                const allocationValue = parseFloat(document.getElementById('editAllocationValue').value);
                const bookingType = document.querySelector('input[name="editBookingType"]:checked').value;
            
            // Validation
            if (!resourceId || !projectId || !startDate || !endDate || !allocationValue) {
                showWarning('Please fill in all required fields.', 'error');
                return;
            }
            
            if (startDate >= endDate) {
                showWarning('End date must be after start date.', 'error');
                return;
            }
            
            try {
                // Map UUIDs to numeric IDs for API
                const selectedResource = resources.find(r => r.id === resourceId);
                const selectedProject = projects.find(p => p.id === projectId);
                const numericResourceId = selectedResource ? resources.indexOf(selectedResource) + 1 : 1;
                const numericProjectId = selectedProject ? projects.indexOf(selectedProject) + 1 : 1;
                
                const updateData = {
                    resourceId: numericResourceId,
                    projectId: numericProjectId,
                    startDate: startDate.toISOString().split('T')[0],
                    endDate: endDate.toISOString().split('T')[0],
                    allocationMethod: currentEditAllocationMethod,
                    allocationValue: allocationValue,
                    type: bookingType
                };
                
                const response = await makeAuthenticatedRequest(`${API_URL}/resource-planning/bookings/${selectedBooking.apiId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Update local booking data
                    const bookingIndex = bookings.findIndex(b => b.id === selectedBooking.id);
                    if (bookingIndex !== -1) {
                        bookings[bookingIndex] = {
                            ...bookings[bookingIndex],
                            resourceId: resourceId,
                            projectId: projectId,
                            startDate: startDate,
                            endDate: endDate,
                            allocationValue: allocationValue,
                            allocationMethod: currentEditAllocationMethod,
                            type: bookingType
                        };
                    }
                    
                    // Refresh the visualization
                    updateGanttChart();
                    closeEditModal();
                    
                    showWarning('Booking updated successfully!', 'success');
                } else {
                    const error = await response.json();
                    showWarning(`Failed to update booking: ${error.message}`, 'error');
                }
            } catch (error) {
                console.error('Error updating booking:', error);
                showWarning('Error updating booking. Please try again.', 'error');
            }
        });
        }

        // CSV Import functionality
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showWarning('Please select a CSV file.', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                parseAndImportCSV(csv);
            };
            reader.readAsText(file);
            
            document.getElementById('fileStatus').textContent = `Selected: ${file.name}`;
        }

        // Parse and import CSV data
        async function parseAndImportCSV(csvData) {
            try {
                const lines = csvData.split('\n').filter(line => line.trim());
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                
                // Expected headers: resource name, project name, start date, end date, allocation value, allocation method, booking type
                const expectedHeaders = ['resource name', 'project name', 'start date', 'end date', 'allocation value', 'allocation method', 'booking type'];
                
                // Validate headers
                const missingHeaders = expectedHeaders.filter(h => !headers.includes(h));
                if (missingHeaders.length > 0) {
                    showWarning(`Missing required columns: ${missingHeaders.join(', ')}`, 'error');
                    return;
                }
                
                const importData = [];
                let errors = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim());
                    if (values.length < headers.length) continue;
                    
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index];
                    });
                    
                    // Validate and convert data
                    const resourceName = row['resource name'];
                    const projectName = row['project name'];
                    const startDate = new Date(row['start date']);
                    const endDate = new Date(row['end date']);
                    const allocationValue = parseFloat(row['allocation value']);
                    const allocationMethod = row['allocation method'];
                    const bookingType = row['booking type'];
                    
                    // Find matching resource and project
                    const resource = resources.find(r => r.name.toLowerCase().includes(resourceName.toLowerCase()));
                    const project = projects.find(p => p.name.toLowerCase().includes(projectName.toLowerCase()));
                    
                    if (!resource) {
                        errors.push(`Row ${i + 1}: Resource "${resourceName}" not found`);
                        continue;
                    }
                    
                    if (!project) {
                        errors.push(`Row ${i + 1}: Project "${projectName}" not found`);
                        continue;
                    }
                    
                    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                        errors.push(`Row ${i + 1}: Invalid date format`);
                        continue;
                    }
                    
                    if (isNaN(allocationValue) || allocationValue <= 0) {
                        errors.push(`Row ${i + 1}: Invalid allocation value`);
                        continue;
                    }
                    
                    if (!['hours', 'percentage', 'total'].includes(allocationMethod)) {
                        errors.push(`Row ${i + 1}: Invalid allocation method. Use: hours, percentage, or total`);
                        continue;
                    }
                    
                    if (!['hard', 'soft'].includes(bookingType)) {
                        errors.push(`Row ${i + 1}: Invalid booking type. Use: hard or soft`);
                        continue;
                    }
                    
                    importData.push({
                        resourceId: resource.id,
                        projectId: project.id,
                        startDate: startDate,
                        endDate: endDate,
                        allocationValue: allocationValue,
                        allocationMethod: allocationMethod,
                        type: bookingType,
                        numericResourceId: resources.indexOf(resource) + 1,
                        numericProjectId: projects.indexOf(project) + 1
                    });
                }
                
                if (errors.length > 0) {
                    console.warn('Import errors:', errors);
                    showWarning(`Import completed with ${errors.length} errors. Check console for details.`, 'warning');
                }
                
                if (importData.length === 0) {
                    showWarning('No valid data found to import.', 'error');
                    return;
                }
                
                // Import the data
                let successful = 0;
                let failed = 0;
                
                for (const booking of importData) {
                    try {
                        const response = await makeAuthenticatedRequest(`${API_URL}/resource-planning/bookings`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                resourceId: booking.numericResourceId,
                                projectId: booking.numericProjectId,
                                startDate: booking.startDate.toISOString().split('T')[0],
                                endDate: booking.endDate.toISOString().split('T')[0],
                                allocationMethod: booking.allocationMethod,
                                allocationValue: booking.allocationValue,
                                type: booking.type
                            })
                        });
                        
                        if (response.ok) {
                            successful++;
                            const result = await response.json();
                            
                            // Add to local bookings array
                            bookings.push({
                                id: Date.now() + Math.random(),
                                apiId: result.data.id,
                                resourceId: booking.resourceId,
                                projectId: booking.projectId,
                                startDate: booking.startDate,
                                endDate: booking.endDate,
                                allocationValue: booking.allocationValue,
                                allocationMethod: booking.allocationMethod,
                                type: booking.type
                            });
                        } else {
                            failed++;
                            console.error('Failed to import booking:', await response.json());
                        }
                    } catch (error) {
                        failed++;
                        console.error('Error importing booking:', error);
                    }
                }
                
                // Refresh the visualization
                updateGanttChart();
                
                showWarning(`Import completed! ${successful} bookings imported successfully, ${failed} failed.`, 'success');
                document.getElementById('fileStatus').textContent = `Import completed: ${successful} successful, ${failed} failed`;
                
            } catch (error) {
                console.error('Error parsing CSV:', error);
                showWarning('Error parsing CSV file. Please check the format.', 'error');
            }
        }

        // Download CSV template
        function downloadTemplate() {
            // Create sample data with current resources and projects
            const templateData = [
                ['Resource Name', 'Project Name', 'Start Date', 'End Date', 'Allocation Value', 'Allocation Method', 'Booking Type'],
                ['John Smith', 'Project Alpha', '2025-11-18', '2025-11-22', '6', 'hours', 'hard'],
                ['Sarah Jones', 'Project Beta', '2025-11-20', '2025-11-27', '75', 'percentage', 'soft'],
                ['Mike Wilson', 'Project Gamma', '2025-11-25', '2025-12-05', '40', 'total', 'hard']
            ];
            
            // Add some actual resource and project names for reference
            if (resources.length > 0 && projects.length > 0) {
                const sampleResource = resources[0].name;
                const sampleProject = projects[0].name;
                templateData.push([sampleResource, sampleProject, '2025-12-01', '2025-12-08', '8', 'hours', 'hard']);
            }
            
            // Convert to CSV
            const csvContent = templateData.map(row => 
                row.map(field => `"${field}"`).join(',')
            ).join('\n');
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'resource_allocation_template.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showWarning('CSV template downloaded successfully! Fill in your data and upload it back.', 'success');
        }

        // Hide context menu when clicking elsewhere
        document.addEventListener('click', function(event) {
            if (!event.target.closest('#contextMenu')) {
                hideContextMenu();
            }
        });

        // Export Gantt chart
        function exportGantt() {
            showWarning('Export functionality will be implemented in the next version.', 'info');
        }
    </script>

    <!-- Context Menu -->
    <div id="contextMenu" class="context-menu">
        <button class="context-menu-item" onclick="editBooking()">
            ‚úèÔ∏è Edit Allocation
        </button>
        <button class="context-menu-item" onclick="toggleBookingStatus()">
            üîÑ Change Status
        </button>
        <div class="context-menu-separator"></div>
        <button class="context-menu-item danger" onclick="deleteBooking()">
            üóëÔ∏è Delete Booking
        </button>
    </div>

    <!-- Edit Booking Modal -->
    <div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 24px; border-radius: 12px; min-width: 400px; max-width: 500px;">
            <h3 style="margin-bottom: 20px;">‚úèÔ∏è Edit Allocation</h3>
            <form id="editBookingForm">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 600;">Project</label>
                    <select id="editProjectSelect" required style="width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 6px;">
                        <option value="">Select Project...</option>
                    </select>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 600;">Resource</label>
                    <select id="editResourceSelect" required style="width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 6px;">
                        <option value="">Select Resource...</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600;">Start Date</label>
                        <input type="date" id="editStartDate" required style="width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 6px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 600;">End Date</label>
                        <input type="date" id="editEndDate" required style="width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 6px;">
                    </div>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 600;">Allocation Method</label>
                    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                        <button type="button" class="allocation-btn" onclick="setEditAllocationMethod('hours')">Hours/Day</button>
                        <button type="button" class="allocation-btn" onclick="setEditAllocationMethod('percentage')">Percentage</button>
                        <button type="button" class="allocation-btn" onclick="setEditAllocationMethod('total')">Total Hours</button>
                    </div>
                    <input type="number" id="editAllocationValue" placeholder="Enter value" required style="width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 6px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 600;">Booking Type</label>
                    <div style="display: flex; gap: 16px;">
                        <label style="display: flex; align-items: center; gap: 6px;">
                            <input type="radio" name="editBookingType" value="hard">
                            Hard Booking
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px;">
                            <input type="radio" name="editBookingType" value="soft">
                            Soft Booking
                        </label>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" onclick="closeEditModal()" style="padding: 10px 20px; border: 1px solid #dee2e6; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
                    <button type="submit" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer;">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>