<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio Management System</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
    
    .container { display: flex; min-height: 100vh; }
    
    nav {
      width: 250px;
      background: #1a1a1a;
      color: white;
      padding: 20px;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }
    
    nav h1 { font-size: 20px; margin-bottom: 30px; }
    nav ul { list-style: none; }
    nav li { margin-bottom: 10px; }
    nav a {
      color: #ccc;
      text-decoration: none;
      display: block;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
    }
    nav a:hover, nav a.active { background: #333; color: white; }
    
    .logout-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 30px;
      width: 100%;
    }
    
    main { margin-left: 250px; padding: 20px; flex: 1; }
    
    .page { display: none; }
    .page.active { display: block; }
    
    .card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    h2 { margin-bottom: 20px; color: #333; }
    
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
    input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
    
    button {
      background: #0066cc;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      margin-top: 10px;
    }
    
    button:hover { background: #0052a3; }
    button.danger { background: #dc3545; }
    button.danger:hover { background: #c82333; }
    
    table { width: 100%; border-collapse: collapse; }
    table th, table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
    table th { background: #f8f9fa; font-weight: bold; }
    table tr:hover { background: #f8f9fa; }
    
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .kpi { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
    .kpi-value { font-size: 32px; font-weight: bold; color: #0066cc; margin: 10px 0; }
    .kpi-label { color: #666; font-size: 14px; }
    
    .alert { padding: 12px; border-radius: 5px; margin-bottom: 15px; }
    .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active { display: flex; }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
    }
    
    /* Keka Sync Styles */
    .sync-section {
      background: #f0f8ff;
      border-left: 4px solid #0066cc;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .sync-info {
      flex: 1;
    }
    
    .sync-title {
      font-weight: bold;
      color: #0066cc;
      margin-bottom: 5px;
    }
    
    .sync-status {
      font-size: 12px;
      color: #666;
    }
    
    .sync-timestamp {
      font-size: 11px;
      color: #999;
      margin-top: 3px;
    }
    
    .sync-button {
      background: #0066cc;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-left: 10px;
      white-space: nowrap;
    }
    
    .sync-button:hover {
      background: #0052a3;
    }
    
    .sync-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .sync-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #0066cc;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 5px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .sync-count {
      display: inline-block;
      background: #0066cc;
      color: white;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 12px;
      margin-left: 10px;
    }

    .sync-result-panel {
      background: #ffffff;
      border: 1px solid #e6e6e6;
      padding: 12px;
      border-radius: 6px;
      margin-top: 12px;
      font-family: monospace;
      font-size: 13px;
      max-height: 260px;
      overflow: auto;
      white-space: pre-wrap;
    }

    .result-actions { text-align: right; margin-bottom: 8px; }
    .copy-btn { background: #eee; color: #333; border: 1px solid #ddd; padding: 6px 10px; border-radius: 4px; cursor: pointer; }
    
    .global-sync {
      background: #28a745;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
    }
    
    .global-sync-btn {
      background: white;
      color: #28a745;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    
    .global-sync-btn:hover {
      background: #f0f0f0;
    }
    
    .global-sync-btn:disabled {
      background: #ccc;
      color: #999;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="container">
    <nav>
      <h1>Portfolio Mgmt</h1>
      <div class="global-sync">
        <div>
          <div style="font-size: 12px; margin-bottom: 5px;">Sync All Data</div>
          <div style="font-size: 12px; opacity: 0.9;" id="global-sync-status">Ready</div>
        </div>
        <button class="global-sync-btn" id="global-sync-btn" onclick="syncAllData()">Sync Now</button>
      </div>
      <ul>
        <li><a onclick="showPage('dashboard')" class="nav-link active">Dashboard</a></li>
        <li><a onclick="showPage('clients')" class="nav-link">Clients</a></li>
        <li><a onclick="showPage('projects')" class="nav-link">Projects</a></li>
        <li><a onclick="showPage('employees')" class="nav-link">Employees</a></li>
      </ul>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </nav>
    
    <main>
      <!-- Dashboard Page -->
      <div id="dashboard" class="page active">
        <h2>Dashboard</h2>
        <div class="grid">
          <div class="kpi">
            <div class="kpi-label">Total Projects</div>
            <div class="kpi-value" id="total-projects">0</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Total Clients</div>
            <div class="kpi-value" id="total-clients">0</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Active Employees</div>
            <div class="kpi-value" id="total-employees">0</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Utilization Rate</div>
            <div class="kpi-value">82%</div>
          </div>
        </div>
      </div>

      <!-- Global Sync Result Panel -->
      <div id="sync-result-card" class="card" style="display:none;">
        <h2>Sync Result</h2>
        <div class="result-actions">
          <button class="copy-btn" id="copy-sync-result" onclick="copySyncResult()">Copy JSON</button>
        </div>
        <div id="sync-result" class="sync-result-panel"></div>
      </div>
      
      <!-- Clients Page -->
      <div id="clients" class="page">
        <div class="card">
          <h2>Clients Management</h2>
          
          <!-- Keka Sync Section -->
          <div class="sync-section">
            <div class="sync-info">
              <div class="sync-title">üì• Sync from Keka</div>
              <div class="sync-status">Import clients directly from Keka PSA</div>
              <div class="sync-timestamp" id="clients-last-sync"></div>
              <div class="sync-count" id="clients-sync-count">Synced: 0</div>
            </div>
            <button class="sync-button" id="clients-sync-btn" onclick="syncClientsFromKeka()">Sync Now</button>
          </div>
          
          <div id="alert" style="display:none;"></div>
          
          <!-- Manual Add Form Disabled - Records only come from Keka -->
          <!--
          <form onsubmit="addClient(event)">
            <div class="form-group">
              <label>Client Name</label>
              <input type="text" id="client-name" required>
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="client-email" required>
            </div>
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" id="client-phone">
            </div>
            <button type="submit">Add Client</button>
          </form>
          -->
          
          <div class="alert alert-info">
            ‚ÑπÔ∏è Clients are automatically synced from Keka. Use "Sync Now" button above to update.
          </div>
        </div>
        
        <div class="card">
          <h2>Clients List</h2>
          
          <!-- Search Box -->
          <div class="form-group" style="margin-bottom: 15px;">
            <input type="text" id="clients-search" placeholder="üîç Search clients by name, email, or phone..." 
                   onkeyup="searchClients()" style="max-width: 400px;">
          </div>
          <table id="clients-table">
            <thead>
              <tr>
                <th>Client Name</th>
              </tr>
            </thead>
            <tbody id="clients-tbody">
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Projects Page -->
      <div id="projects" class="page">
        <div class="card">
          <h2>Projects Management</h2>
          
          <!-- Keka Sync Section -->
          <div class="sync-section">
            <div class="sync-info">
              <div class="sync-title">üì• Sync from Keka</div>
              <div class="sync-status">Import projects directly from Keka PSA</div>
              <div class="sync-timestamp" id="projects-last-sync"></div>
              <div class="sync-count" id="projects-sync-count">Synced: 0</div>
            </div>
            <button class="sync-button" id="projects-sync-btn" onclick="syncProjectsFromKeka()">Sync Now</button>
          </div>
          
          <!-- Manual Add Form Disabled - Records only come from Keka -->
          <!--
          <form onsubmit="addProject(event)">
            <div class="form-group">
              <label>Project Name</label>
              <input type="text" id="project-name" required>
            </div>
            <div class="form-group">
              <label>Client</label>
              <select id="project-client" required>
                <option value="">Select Client</option>
              </select>
            </div>
            <div class="form-group">
              <label>Budget</label>
              <input type="number" id="project-budget" required>
            </div>
            <button type="submit">Add Project</button>
          </form>
          -->
          
          <div class="alert alert-info">
            ‚ÑπÔ∏è Projects are automatically synced from Keka. Use "Sync Now" button above to update.
          </div>
        </div>
        
        <div class="card">
          <h2>Projects List</h2>
          
          <!-- Search Box -->
          <div class="form-group" style="margin-bottom: 15px;">
            <input type="text" id="projects-search" placeholder="üîç Search projects by name, client, or budget..." 
                   onkeyup="searchProjects()" style="max-width: 400px;">
          </div>
          <table id="projects-table">
            <thead>
              <tr>
                <th>Project Name</th>
                <th>Client Name</th>
                <th>Billing Type</th>
                <th>Billable</th>
              </tr>
            </thead>
            <tbody id="projects-tbody">
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Employees Page -->
      <div id="employees" class="page">
        <div class="card">
          <h2>Employees Management</h2>
          
          <!-- Keka Sync Section -->
          <div class="sync-section">
            <div class="sync-info">
              <div class="sync-title">üì• Sync from Keka</div>
              <div class="sync-status">Import active employees directly from Keka HRIS</div>
              <div class="sync-timestamp" id="employees-last-sync"></div>
              <div class="sync-count" id="employees-sync-count">Synced: 0</div>
            </div>
            <button class="sync-button" id="employees-sync-btn" onclick="syncEmployeesFromKeka()">Sync Now</button>
          </div>
          
          <!-- Manual Add Form Disabled - Records only come from Keka -->
          <!--
          <form onsubmit="addEmployee(event)">
            <div class="form-group">
              <label>First Name</label>
              <input type="text" id="employee-first" required>
            </div>
            <div class="form-group">
              <label>Last Name</label>
              <input type="text" id="employee-last" required>
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="employee-email" required>
            </div>
            <div class="form-group">
              <label>Department</label>
              <input type="text" id="employee-dept">
            </div>
            <button type="submit">Add Employee</button>
          </form>
          -->
          
          <div class="alert alert-info">
            ‚ÑπÔ∏è Employees are automatically synced from Keka. Use "Sync Now" button above to update.
          </div>
        </div>
        
        <div class="card">
          <h2>Employees List</h2>
          
          <!-- Search Box -->
          <div class="form-group" style="margin-bottom: 15px;">
            <input type="text" id="employees-search" placeholder="üîç Search employees by name, email, or department..." 
                   onkeyup="searchEmployees()" style="max-width: 400px;">
          </div>
          <table id="employees-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Job Title</th>
                <th>Department</th>
              </tr>
            </thead>
            <tbody id="employees-tbody">
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script>
    const API_URL = 'http://127.0.0.1:3001/api';
    let currentUser = null;
    let isRedirecting = false;

    // Check if user is logged in
    window.addEventListener('load', () => {
      const token = localStorage.getItem('token');
      if (!token) {
        if (!isRedirecting) {
          isRedirecting = true;
          window.location.href = 'login.html';
        }
      } else {
        loadDashboardData();
        initializeSyncStatus();
      }
    });

    function showPage(pageName) {
      // Hide all pages
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      
      // Show selected page
      document.getElementById(pageName).classList.add('active');
      event.target.classList.add('active');
      
      // Load page data
      if (pageName === 'clients') loadClients();
      else if (pageName === 'projects') loadProjects();
      else if (pageName === 'employees') loadEmployees();
    }

    async function loadDashboardData() {
      try {
        const token = localStorage.getItem('token');
        
        // Get current user
        const userRes = await fetch(`${API_URL}/auth/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const userData = await userRes.json();
        
        if (userData.success) {
          currentUser = userData.data;
          // Store company ID for later use
          if (userData.data.companyId) {
            localStorage.setItem('companyId', userData.data.companyId);
          }
          
          // Get real data for KPIs
          try {
            // Get projects count
            const projectsRes = await fetch(`${API_URL}/projects`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            const projectsData = await projectsRes.json();
            const projectCount = projectsData.success ? projectsData.total || 0 : 0;
            document.getElementById('total-projects').textContent = projectCount;
            
            // Get clients count
            const clientsRes = await fetch(`${API_URL}/clients`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            const clientsData = await clientsRes.json();
            const clientCount = clientsData.success ? clientsData.total || 0 : 0;
            document.getElementById('total-clients').textContent = clientCount;
            
            // Get employees count
            const empRes = await fetch(`${API_URL}/employees`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            const empData = await empRes.json();
            const empCount = empData.success ? empData.total || 0 : 0;
            document.getElementById('total-employees').textContent = empCount;
            
          } catch (e) {
            console.error('Error loading KPI data:', e);
            document.getElementById('total-projects').textContent = '0';
            document.getElementById('total-clients').textContent = '0';
            document.getElementById('total-employees').textContent = '0';
          }
        } else {
          // Auth failed, clear token and redirect
          if (!isRedirecting) {
            isRedirecting = true;
            localStorage.removeItem('token');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('companyId');
            window.location.href = 'login.html';
          }
        }
      } catch (e) {
        console.error('Failed to load dashboard:', e);
        // Network error or server down, clear token and redirect
        if (!isRedirecting) {
          isRedirecting = true;
          localStorage.removeItem('token');
          localStorage.removeItem('refreshToken');
          localStorage.removeItem('companyId');
          window.location.href = 'login.html';
        }
      }
    }

    async function addClient(e) {
      e.preventDefault();
      const name = document.getElementById('client-name').value;
      const email = document.getElementById('client-email').value;
      const phone = document.getElementById('client-phone').value;
      
      try {
        const token = localStorage.getItem('token');
        const companyId = localStorage.getItem('companyId') || currentUser?.companyId;
        
        if (!companyId) {
          showAlert('Company ID not found. Please log in again.', 'error', 'alert');
          return;
        }
        
        const response = await fetch(`${API_URL}/clients`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            company_id: companyId,
            name,
            email,
            phone,
            is_active: true
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showAlert('Client added successfully!', 'success', 'alert');
          e.target.reset();
          loadClients();
        } else {
          showAlert('Error: ' + data.message, 'error', 'alert');
        }
      } catch (error) {
        console.error('Error adding client:', error);
        showAlert('Failed to add client: ' + error.message, 'error', 'alert');
      }
    }

    async function loadClients() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_URL}/clients`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await response.json();
        const tbody = document.getElementById('clients-tbody');
        tbody.innerHTML = '';
        
        if (data.success && Array.isArray(data.data)) {
          data.data.forEach(client => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${client.name}</td>
            `;
            tbody.appendChild(tr);
          });
        } else {
          tbody.innerHTML = '<tr><td>No clients found</td></tr>';
        }
      } catch (error) {
        console.error('Error loading clients:', error);
        showAlert('Failed to load clients: ' + error.message, 'error', 'alert');
      }
    }

    async function deleteClient(id) {
      if (!confirm('Are you sure you want to delete this client?')) return;
      
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_URL}/clients/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await response.json();
        
        if (data.success) {
          showAlert('Client deleted successfully!', 'success', 'alert');
          loadClients();
        } else {
          showAlert('Error: ' + data.message, 'error', 'alert');
        }
      } catch (error) {
        console.error('Error deleting client:', error);
        showAlert('Failed to delete client: ' + error.message, 'error', 'alert');
      }
    }

    async function addProject(e) {
      e.preventDefault();
      const name = document.getElementById('project-name').value;
      const clientId = document.getElementById('project-client').value;
      const budget = parseFloat(document.getElementById('project-budget').value);
      
      try {
        const token = localStorage.getItem('token');
        const companyId = localStorage.getItem('companyId') || currentUser?.companyId;
        
        if (!companyId) {
          showAlert('Company ID not found. Please log in again.', 'error', 'alert');
          return;
        }
        
        if (!clientId) {
          showAlert('Please select a client', 'error', 'alert');
          return;
        }
        
        const response = await fetch(`${API_URL}/projects`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            company_id: companyId,
            client_id: clientId,
            name,
            budget,
            start_date: new Date().toISOString().split('T')[0],
            end_date: new Date(Date.now() + 90*24*60*60*1000).toISOString().split('T')[0],
            status: 'active'
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showAlert('Project added successfully!', 'success', 'alert');
          e.target.reset();
          loadProjects();
        } else {
          showAlert('Error: ' + data.message, 'error', 'alert');
        }
      } catch (error) {
        console.error('Error adding project:', error);
        showAlert('Failed to add project: ' + error.message, 'error', 'alert');
      }
    }

    async function loadProjects() {
      try {
        const token = localStorage.getItem('token');
        
        // Load projects
        const projectsRes = await fetch(`${API_URL}/projects`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const projectsData = await projectsRes.json();
        
        // Load clients for dropdown
        const clientsRes = await fetch(`${API_URL}/clients`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const clientsData = await clientsRes.json();
        
        const tbody = document.getElementById('projects-tbody');
        tbody.innerHTML = '';
        
        // Update client select (only if form exists - it's commented out now)
        const select = document.getElementById('project-client');
        if (select) {
          select.innerHTML = '<option value="">Select Client</option>';
          if (clientsData.success && Array.isArray(clientsData.data)) {
            clientsData.data.forEach(c => {
              select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
          }
        }
        
        // Populate projects table
        if (projectsData.success && Array.isArray(projectsData.data)) {
          projectsData.data.forEach(project => {
            // Find client by keka_id matching project's keka_client_id
            const client = clientsData.data?.find(c => c.keka_id === project.keka_client_id);
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${project.name}</td>
              <td>${client?.name || 'Unknown Client'}</td>
              <td>${project.billing_type || '-'}</td>
              <td>${project.is_billable ? 'Yes' : 'No'}</td>
            `;
            tbody.appendChild(tr);
          });
        } else {
          tbody.innerHTML = '<tr><td colspan="4">No projects found</td></tr>';
        }
      } catch (error) {
        console.error('Error loading projects:', error);
        showAlert('Failed to load projects: ' + error.message, 'error', 'alert');
      }
    }

    async function deleteProject(id) {
      if (!confirm('Are you sure you want to delete this project?')) return;
      
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_URL}/projects/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await response.json();
        
        if (data.success) {
          showAlert('Project deleted successfully!', 'success', 'alert');
          loadProjects();
        } else {
          showAlert('Error: ' + data.message, 'error', 'alert');
        }
      } catch (error) {
        console.error('Error deleting project:', error);
        showAlert('Failed to delete project: ' + error.message, 'error', 'alert');
      }
    }

    async function addEmployee(e) {
      e.preventDefault();
      const firstName = document.getElementById('employee-first').value;
      const lastName = document.getElementById('employee-last').value;
      const email = document.getElementById('employee-email').value;
      const department = document.getElementById('employee-dept').value;
      
      try {
        const token = localStorage.getItem('token');
        const companyId = localStorage.getItem('companyId') || currentUser?.companyId;
        
        if (!companyId) {
          showAlert('Company ID not found. Please log in again.', 'error', 'alert');
          return;
        }
        
        const response = await fetch(`${API_URL}/employees`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            company_id: companyId,
            first_name: firstName,
            last_name: lastName,
            email,
            employee_id: `EMP-${Date.now()}`,
            department,
            date_of_joining: new Date().toISOString().split('T')[0],
            is_active: true
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showAlert('Employee added successfully!', 'success', 'alert');
          e.target.reset();
          loadEmployees();
        } else {
          showAlert('Error: ' + data.message, 'error', 'alert');
        }
      } catch (error) {
        console.error('Error adding employee:', error);
        showAlert('Failed to add employee: ' + error.message, 'error', 'alert');
      }
    }

    async function loadEmployees() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_URL}/employees`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await response.json();
        const tbody = document.getElementById('employees-tbody');
        tbody.innerHTML = '';
        
        if (data.success && Array.isArray(data.data)) {
          data.data.forEach(emp => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${emp.first_name} ${emp.last_name}</td>
              <td>${emp.email}</td>
              <td>${emp.designation || '-'}</td>
              <td>${emp.department || '-'}</td>
            `;
            tbody.appendChild(tr);
          });
        } else {
          tbody.innerHTML = '<tr><td colspan="4">No employees found</td></tr>';
        }
      } catch (error) {
        console.error('Error loading employees:', error);
        showAlert('Failed to load employees: ' + error.message, 'error', 'alert');
      }
    }

    async function deleteEmployee(id) {
      if (!confirm('Are you sure you want to delete this employee?')) return;
      
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_URL}/employees/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await response.json();
        
        if (data.success) {
          showAlert('Employee deleted successfully!', 'success', 'alert');
          loadEmployees();
        } else {
          showAlert('Error: ' + data.message, 'error', 'alert');
        }
      } catch (error) {
        console.error('Error deleting employee:', error);
        showAlert('Failed to delete employee: ' + error.message, 'error', 'alert');
      }
    }

    function showAlert(message, type, elementId) {
      const alert = document.getElementById(elementId || 'alert');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      alert.style.display = 'block';
      setTimeout(() => { alert.style.display = 'none'; }, 3000);
    }

    function copySyncResult() {
      try {
        const text = document.getElementById('sync-result').textContent || '';
        if (!text) return showAlert('No sync result to copy', 'error', 'alert');
        navigator.clipboard.writeText(text).then(() => {
          showAlert('Sync JSON copied to clipboard', 'success', 'alert');
        }).catch((e) => {
          // fallback
          const ta = document.createElement('textarea');
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          showAlert('Sync JSON copied to clipboard', 'success', 'alert');
        });
      } catch (e) {
        console.error('Copy failed', e);
        showAlert('Copy failed', 'error', 'alert');
      }
    }

    // ============ SEARCH FUNCTIONS ============
    
    function searchClients() {
      const searchTerm = document.getElementById('clients-search').value.toLowerCase();
      const table = document.getElementById('clients-table');
      const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
      
      let visibleCount = 0;
      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        
        // Skip "no data" rows
        if (cells.length === 1) continue;
        
        const name = cells[0]?.textContent?.toLowerCase() || '';
        const email = cells[1]?.textContent?.toLowerCase() || '';
        const phone = cells[2]?.textContent?.toLowerCase() || '';
        
        if (name.includes(searchTerm) || email.includes(searchTerm) || phone.includes(searchTerm)) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      }
      
      // Show message if no results
      if (visibleCount === 0 && searchTerm) {
        const tbody = table.getElementsByTagName('tbody')[0];
        if (!document.getElementById('no-results-clients')) {
          const noResults = document.createElement('tr');
          noResults.id = 'no-results-clients';
          noResults.innerHTML = '<td colspan="4" style="text-align:center;color:#999;">No clients found matching your search</td>';
          tbody.appendChild(noResults);
        }
      } else {
        const noResults = document.getElementById('no-results-clients');
        if (noResults) noResults.remove();
      }
    }
    
    function searchProjects() {
      const searchTerm = document.getElementById('projects-search').value.toLowerCase();
      const table = document.getElementById('projects-table');
      const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
      
      let visibleCount = 0;
      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        
        // Skip "no data" rows
        if (cells.length === 1) continue;
        
        const name = cells[0]?.textContent?.toLowerCase() || '';
        const client = cells[1]?.textContent?.toLowerCase() || '';
        const budget = cells[2]?.textContent?.toLowerCase() || '';
        
        if (name.includes(searchTerm) || client.includes(searchTerm) || budget.includes(searchTerm)) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      }
      
      // Show message if no results
      if (visibleCount === 0 && searchTerm) {
        const tbody = table.getElementsByTagName('tbody')[0];
        if (!document.getElementById('no-results-projects')) {
          const noResults = document.createElement('tr');
          noResults.id = 'no-results-projects';
          noResults.innerHTML = '<td colspan="4" style="text-align:center;color:#999;">No projects found matching your search</td>';
          tbody.appendChild(noResults);
        }
      } else {
        const noResults = document.getElementById('no-results-projects');
        if (noResults) noResults.remove();
      }
    }
    
    function searchEmployees() {
      const searchTerm = document.getElementById('employees-search').value.toLowerCase();
      const table = document.getElementById('employees-table');
      const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
      
      let visibleCount = 0;
      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        
        // Skip "no data" rows
        if (cells.length === 1) continue;
        
        const name = cells[0]?.textContent?.toLowerCase() || '';
        const email = cells[1]?.textContent?.toLowerCase() || '';
        const department = cells[2]?.textContent?.toLowerCase() || '';
        
        if (name.includes(searchTerm) || email.includes(searchTerm) || department.includes(searchTerm)) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      }
      
      // Show message if no results
      if (visibleCount === 0 && searchTerm) {
        const tbody = table.getElementsByTagName('tbody')[0];
        if (!document.getElementById('no-results-employees')) {
          const noResults = document.createElement('tr');
          noResults.id = 'no-results-employees';
          noResults.innerHTML = '<td colspan="4" style="text-align:center;color:#999;">No employees found matching your search</td>';
          tbody.appendChild(noResults);
        }
      } else {
        const noResults = document.getElementById('no-results-employees');
        if (noResults) noResults.remove();
      }
    }

    // ============ KEKA SYNC FUNCTIONS ============
    
    async function syncClientsFromKeka() {
      await performSync('clients', 'Syncing clients from Keka...');
    }
    
    async function syncProjectsFromKeka() {
      await performSync('projects', 'Syncing projects from Keka...');
    }
    
    async function syncEmployeesFromKeka() {
      await performSync('employees', 'Syncing employees from Keka...');
    }
    
    async function syncAllData() {
      try {
        const btn = document.getElementById('global-sync-btn');
        const status = document.getElementById('global-sync-status');
        
        btn.disabled = true;
        status.innerHTML = '<span class="sync-spinner"></span>Syncing all data...';
        
        const token = localStorage.getItem('token');
        
        // Call sync all endpoint
        const response = await fetch(`${API_URL}/keka/sync/all`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await response.json();

        // Show detailed result panel
        document.getElementById('sync-result-card').style.display = 'block';
        document.getElementById('sync-result').textContent = JSON.stringify(data, null, 2);

        if (data.success) {
          status.textContent = 'All synced successfully!';
          showAlert('‚úÖ All data synced successfully!', 'success', 'alert');

          // Reload all pages
          loadClients();
          loadProjects();
          loadEmployees();
          loadDashboardData();

          // Update status after 2 seconds
          setTimeout(() => {
            status.textContent = 'Ready';
            btn.disabled = false;
          }, 2000);
        } else {
          status.textContent = 'Sync failed';
          showAlert('‚ùå Sync failed: ' + (data.message || 'see details'), 'error', 'alert');
          btn.disabled = false;
        }
      } catch (error) {
        console.error('Error syncing all data:', error);
        showAlert('‚ùå Sync failed: ' + error.message, 'error', 'alert');
        document.getElementById('global-sync-btn').disabled = false;
        document.getElementById('global-sync-status').textContent = 'Error';
      }
    }
    
    async function performSync(type, message) {
      try {
        const btn = document.getElementById(`${type}-sync-btn`);
        const statusDiv = document.getElementById(`${type}-last-sync`);
        
        btn.disabled = true;
        btn.innerHTML = '<span class="sync-spinner"></span>Syncing...';
        
        const token = localStorage.getItem('token');
        
        // Call appropriate sync endpoint
        const response = await fetch(`${API_URL}/keka/sync/${type}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await response.json();

        // show per-type details in the global result panel too
        document.getElementById('sync-result-card').style.display = 'block';
        const prev = document.getElementById('sync-result').textContent || '';
        const merged = Object.assign({}, JSON.parse(prev || '{}'), { [type]: data });
        document.getElementById('sync-result').textContent = JSON.stringify(merged, null, 2);

        if (data.success) {
          const count = data.synced || data.data?.synced || 0;
          const timestamp = new Date().toLocaleTimeString();

          statusDiv.textContent = `Last synced: ${timestamp} (${count} items)`;
          document.getElementById(`${type}-sync-count`).textContent = `Synced: ${count}`;

          showAlert(`‚úÖ ${count} ${type} synced successfully!`, 'success', 'alert');

          // Reload the data
          if (type === 'clients') loadClients();
          else if (type === 'projects') loadProjects();
          else if (type === 'employees') loadEmployees();

          // Reset button after 2 seconds
          setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = 'Sync Now';
          }, 2000);
        } else {
          showAlert(`‚ùå Sync failed: ${data.message || 'see details'}`, 'error', 'alert');
          btn.disabled = false;
          btn.innerHTML = 'Sync Now';
        }
      } catch (error) {
        console.error(`Error syncing ${type}:`, error);
        showAlert(`‚ùå Sync failed: ${error.message}`, 'error', 'alert');
        const btn = document.getElementById(`${type}-sync-btn`);
        btn.disabled = false;
        btn.innerHTML = 'Sync Now';
      }
    }
    
    // Initialize sync status on page load
    async function initializeSyncStatus() {
      try {
        const token = localStorage.getItem('token');
        
        // Get sync status - call once, not per type
        try {
          const response = await fetch(`${API_URL}/keka/sync/status`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (response.ok) {
            const data = await response.json();
            if (data.success) {
              // Update each type's status
              const types = ['clients', 'projects', 'employees'];
              for (const type of types) {
                if (data[type]) {
                  const count = data[type].count || 0;
                  const lastSync = data[type].lastSync 
                    ? new Date(data[type].lastSync).toLocaleString() 
                    : 'Never';
                  
                  const statusDiv = document.getElementById(`${type}-last-sync`);
                  const countDiv = document.getElementById(`${type}-sync-count`);
                  
                  if (statusDiv) statusDiv.textContent = `Last synced: ${lastSync}`;
                  if (countDiv) countDiv.textContent = `Synced: ${count}`;
                }
              }
            }
          }
        } catch (e) {
          // Silent fail for status endpoint
          console.error('Error fetching sync status:', e);
        }
      } catch (error) {
        console.error('Error initializing sync status:', error);
      }
    }

    function showAlert(message, type, elementId) {
      const alert = document.getElementById(elementId || 'alert');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      alert.style.display = 'block';
      setTimeout(() => { alert.style.display = 'none'; }, 3000);
    }

    function logout() {
      if (!isRedirecting) {
        isRedirecting = true;
        localStorage.removeItem('token');
        localStorage.removeItem('refreshToken');
        localStorage.removeItem('companyId');
        window.location.href = 'login.html';
      }
    }
  </script>
</body>
</html>
